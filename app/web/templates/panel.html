<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{{ app_name }} ‚Äî Painel</title>
  <link rel="stylesheet" href="/static/style.css" />
  <style>
    /* Reset e base styles com inspira√ß√£o Apple */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #121212 0%, #1e1e1e 100%);
      min-height: 100vh;
      color: #ffffff;
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Layout principal */
    .layout { 
      display: grid; 
      grid-template-columns: 280px 1fr; 
      min-height: 100vh; 
      gap: 0;
    }

    /* Sidebar estilo Apple */
    .sidebar { 
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-right: 1px solid rgba(255, 255, 255, 0.1);
      padding: 32px 24px;
      position: relative;
      overflow: hidden;
    }

    .sidebar::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
      pointer-events: none;
    }

    .sidebar h2 { 
      font-size: 24px; 
      font-weight: 700;
      margin: 0 0 32px; 
      color: #ffffff;
      letter-spacing: -0.02em;
    }

    .sidebar nav {
      margin-bottom: 40px;
    }

    .sidebar a { 
      display: flex;
      align-items: center;
      color: rgba(255, 255, 255, 0.8); 
      text-decoration: none; 
      padding: 12px 16px; 
      border-radius: 12px;
      margin-bottom: 8px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-weight: 500;
      position: relative;
      overflow: hidden;
    }

    .sidebar a::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
      transition: left 0.5s;
    }

    .sidebar a:hover { 
      background: rgba(255, 255, 255, 0.1);
      color: #ffffff;
      transform: translateX(4px);
    }

    .sidebar a:hover::before {
      left: 100%;
    }

    .sidebar .section {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 16px;
      padding: 20px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .sidebar .section p {
        color: rgba(255, 255, 255, 0.9);
        font-size: 14px;
        margin-bottom: 8px;
      }

    .sidebar .section p:last-child {
      color: #ffffff;
      font-weight: 600;
      margin-bottom: 0;
    }

    /* Content area */
    .content { 
      padding: 40px;
      background: rgba(255, 255, 255, 0.02);
    }

    /* Header */
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 48px;
    }

    header h1 {
      font-size: 3.5rem;
      font-weight: 700;
      background: linear-gradient(135deg, #ffffff 0%, #f0f0f0 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-shadow: 0 4px 20px rgba(255, 255, 255, 0.3);
      letter-spacing: -0.02em;
    }

    /* Cards com glassmorphism */
    .cards { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); 
      gap: 24px; 
      margin-bottom: 48px; 
    }

    .card { 
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      padding: 32px;
      box-shadow: 
        0 8px 32px rgba(0, 0, 0, 0.3),
        0 1px 0 rgba(255, 255, 255, 0.1) inset;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
      transition: left 0.5s;
    }

    .card:hover {
      transform: translateY(-8px);
      box-shadow: 
        0 20px 40px rgba(0, 0, 0, 0.15),
        0 1px 0 rgba(255, 255, 255, 0.3) inset;
    }

    .card:hover::before {
      left: 100%;
    }

    .card h3 { 
      margin: 0 0 16px; 
      font-size: 16px; 
      color: rgba(255, 255, 255, 0.8);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .card .value { 
      font-size: 2.5rem; 
      font-weight: 700;
      color: #ffffff;
      margin-bottom: 8px;
      line-height: 1.2;
    }

    .card .muted {
       color: rgba(255, 255, 255, 0.9);
       font-size: 14px;
     }

    .card .muted a {
      color: rgba(255, 255, 255, 0.8);
      text-decoration: none;
      border-bottom: 1px solid rgba(255, 255, 255, 0.3);
      transition: all 0.3s ease;
    }

    .card .muted a:hover {
      color: #ffffff;
      border-bottom-color: #ffffff;
    }

    /* Sections */
    .section { 
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 20px;
      padding: 32px;
      margin-bottom: 32px;
      box-shadow: 
        0 8px 32px rgba(0, 0, 0, 0.1),
        0 1px 0 rgba(255, 255, 255, 0.2) inset;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .section:hover {
      transform: translateY(-4px);
      box-shadow: 
        0 20px 40px rgba(0, 0, 0, 0.15),
        0 1px 0 rgba(255, 255, 255, 0.3) inset;
    }

    .section h2 { 
      margin: 0 0 24px; 
      font-size: 1.75rem;
      font-weight: 600;
      color: #ffffff;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    /* Formul√°rios estilo Apple */
    .form-row { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
      gap: 24px; 
    }

    .form-group {
      margin-bottom: 24px;
    }

    .form-group label {
      display: block;
      font-weight: 500;
      color: #ffffff;
      margin-bottom: 8px;
      font-size: 0.95rem;
    }

    .input { 
      background: rgba(255, 255, 255, 0.1);
      color: #ffffff;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      padding: 16px 20px;
      width: 100%;
      font-size: 1rem;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      backdrop-filter: blur(10px);
    }

    .input:focus {
      outline: none;
      border-color: rgba(255, 255, 255, 0.4);
      background: rgba(255, 255, 255, 0.15);
      box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.1);
      transform: translateY(-2px);
    }

    .input::placeholder {
       color: rgba(255, 255, 255, 0.8);
     }

    /* Bot√µes com estilo Apple */
    .btn { 
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      background: linear-gradient(135deg, #333333 0%, #000000 100%);
      color: #ffffff;
      border: none;
      border-radius: 12px;
      padding: 16px 32px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      text-decoration: none;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      -webkit-user-select: none;
      user-select: none;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
    }

    .btn:hover::before {
      left: 100%;
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn.secondary { 
      background: rgba(255, 255, 255, 0.1);
      color: #ffffff;
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 4px 20px rgba(255, 255, 255, 0.1);
    }

    .btn.secondary:hover {
      background: rgba(255, 255, 255, 0.2);
      box-shadow: 0 8px 30px rgba(255, 255, 255, 0.2);
    }

    /* Bot√£o de treinamento animado */
    .train-btn {
      background: linear-gradient(135deg, #34D399 0%, #10B981 100%);
      color: white;
      box-shadow: 0 4px 20px rgba(52, 211, 153, 0.3);
      position: relative;
      overflow: hidden;
    }

    .train-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 30px rgba(52, 211, 153, 0.4);
    }

    .train-btn.loading {
      pointer-events: none;
      background: linear-gradient(135deg, #6B7280 0%, #4B5563 100%);
    }

    .train-btn .btn-content {
      display: flex;
      align-items: center;
      gap: 8px;
      transition: opacity 0.3s ease;
    }

    .train-btn .btn-loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      display: none;
      align-items: center;
      gap: 8px;
    }

    .train-btn.loading .btn-content {
      opacity: 0;
    }

    .train-btn.loading .btn-loading {
      display: flex;
    }

    .btn-icon {
      width: 16px;
      height: 16px;
      fill: currentColor;
    }

    .loading-spinner {
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top: 2px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Grid responsivo */
    .grid { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); 
      gap: 24px; 
    }

    /* Tabelas */
    .table { 
      width: 100%; 
      border-collapse: collapse;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 16px;
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .table th, .table td { 
      border: none;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      padding: 16px 20px;
      text-align: left;
    }

    .table th {
      background: rgba(255, 255, 255, 0.1);
      font-weight: 600;
      color: #ffffff;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .table td {
      color: rgba(255, 255, 255, 0.9);
    }

    .table tr:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    /* Pills e status */
    .pill { 
      padding: 6px 12px; 
      border-radius: 20px; 
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .pill.ok { 
      background: rgba(34, 197, 94, 0.2); 
      color: #22c55e;
      border: 1px solid rgba(34, 197, 94, 0.3);
    }

    .pill.warn { 
      background: rgba(245, 158, 11, 0.2); 
      color: #f59e0b;
      border: 1px solid rgba(245, 158, 11, 0.3);
    }

    /* Utilit√°rios */
     .muted { 
       color: rgba(255, 255, 255, 0.9); 
       font-size: 14px; 
     }

    .row { 
      display: flex; 
      gap: 16px; 
      align-items: center; 
    }

    /* Checkbox personalizado */
    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
    }

    .checkbox-row input[type="checkbox"] {
      width: 20px;
      height: 20px;
      accent-color: #333333;
    }

    /* Responsividade */
    @media (max-width: 1024px) {
      .layout {
        grid-template-columns: 1fr;
      }
      
      .sidebar {
        display: none;
      }
    }

    @media (max-width: 768px) {
      .content {
        padding: 20px 16px;
      }

      header h1 {
        font-size: 2.5rem;
      }

      .cards {
        grid-template-columns: 1fr;
      }

      .form-row {
        grid-template-columns: 1fr;
      }
    }

    /* Scrollbar personalizada */
     ::-webkit-scrollbar {
       width: 8px;
     }

     ::-webkit-scrollbar-track {
       background: rgba(255, 255, 255, 0.1);
       border-radius: 4px;
     }

     ::-webkit-scrollbar-thumb {
       background: rgba(255, 255, 255, 0.3);
       border-radius: 4px;
     }

     ::-webkit-scrollbar-thumb:hover {
       background: rgba(255, 255, 255, 0.5);
     }

     /* Estilos espec√≠ficos para se√ß√£o de treinamento ativo */
     .training-header {
       display: flex;
       justify-content: space-between;
       align-items: center;
       margin-bottom: 32px;
       padding: 24px;
       background: rgba(255, 255, 255, 0.05);
       border-radius: 16px;
       border: 1px solid rgba(255, 255, 255, 0.1);
     }

     .training-status {
       display: flex;
       align-items: center;
       gap: 24px;
     }

     .status-indicator {
       display: flex;
       align-items: center;
       gap: 12px;
     }

     .pulse-dot {
       width: 12px;
       height: 12px;
       background: #34D399;
       border-radius: 50%;
       animation: pulse 2s infinite;
       box-shadow: 0 0 0 0 rgba(52, 211, 153, 0.7);
     }

     @keyframes pulse {
       0% {
         transform: scale(0.95);
         box-shadow: 0 0 0 0 rgba(52, 211, 153, 0.7);
       }
       70% {
         transform: scale(1);
         box-shadow: 0 0 0 10px rgba(52, 211, 153, 0);
       }
       100% {
         transform: scale(0.95);
         box-shadow: 0 0 0 0 rgba(52, 211, 153, 0);
       }
     }

     .progress-circle {
       width: 80px;
       height: 80px;
       border-radius: 50%;
       background: conic-gradient(#34D399 0deg, rgba(255, 255, 255, 0.1) 0deg);
       display: flex;
       align-items: center;
       justify-content: center;
       position: relative;
       transition: all 0.3s ease;
     }

     .progress-circle::before {
       content: '';
       position: absolute;
       width: 60px;
       height: 60px;
       background: rgba(255, 255, 255, 0.1);
       border-radius: 50%;
       backdrop-filter: blur(10px);
     }

     .progress-value {
       position: relative;
       z-index: 1;
       font-weight: 700;
       font-size: 14px;
       color: #ffffff;
     }

     .training-controls {
       display: flex;
       gap: 12px;
       align-items: center;
     }

     .btn-control {
       display: flex;
       align-items: center;
       gap: 8px;
       padding: 12px 20px;
       border: none;
       border-radius: 12px;
       font-weight: 600;
       font-size: 14px;
       cursor: pointer;
       transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
       position: relative;
       overflow: hidden;
       backdrop-filter: blur(10px);
     }

     .btn-control::before {
       content: '';
       position: absolute;
       top: 0;
       left: -100%;
       width: 100%;
       height: 100%;
       background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
       transition: left 0.5s;
     }

     .btn-control:hover::before {
       left: 100%;
     }

     .btn-control.pause {
       background: rgba(245, 158, 11, 0.2);
       color: #f59e0b;
       border: 1px solid rgba(245, 158, 11, 0.3);
     }

     .btn-control.pause:hover {
       background: rgba(245, 158, 11, 0.3);
       transform: translateY(-2px);
       box-shadow: 0 8px 25px rgba(245, 158, 11, 0.3);
     }

     .btn-control.resume {
       background: rgba(34, 197, 94, 0.2);
       color: #22c55e;
       border: 1px solid rgba(34, 197, 94, 0.3);
     }

     .btn-control.resume:hover {
       background: rgba(34, 197, 94, 0.3);
       transform: translateY(-2px);
       box-shadow: 0 8px 25px rgba(34, 197, 94, 0.3);
     }

     .btn-control.stop {
       background: rgba(239, 68, 68, 0.2);
       color: #ef4444;
       border: 1px solid rgba(239, 68, 68, 0.3);
     }

     .btn-control.stop:hover {
       background: rgba(239, 68, 68, 0.3);
       transform: translateY(-2px);
       box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3);
     }

     .control-icon {
       width: 16px;
       height: 16px;
       fill: currentColor;
     }

     /* Sistema de notifica√ß√µes */
     .notification {
       position: fixed;
       top: 24px;
       right: 24px;
       background: rgba(255, 255, 255, 0.95);
       backdrop-filter: blur(20px);
       -webkit-backdrop-filter: blur(20px);
       border: 1px solid rgba(255, 255, 255, 0.2);
       border-radius: 16px;
       padding: 20px 24px;
       box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
       z-index: 1000;
       transform: translateX(400px);
       transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
       max-width: 350px;
       color: #1d1d1f;
     }

     .notification.show {
       transform: translateX(0);
     }

     .notification.success {
       border-left: 4px solid #34D399;
     }

     .notification.error {
       border-left: 4px solid #ef4444;
     }

     .notification.warning {
       border-left: 4px solid #f59e0b;
     }

     .notification .notification-title {
       font-weight: 600;
       margin-bottom: 4px;
       font-size: 16px;
     }

     .notification .notification-message {
       font-size: 14px;
       opacity: 0.8;
       line-height: 1.4;
     }
  </style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <h2>EV Dashboard</h2>
      <nav>
        <a href="/panel">Vis√£o Geral</a>
        <a href="/settings">Configura√ß√µes</a>
        <a href="/">In√≠cio simples</a>
        <a href="/docs" target="_blank">API Docs</a>
      </nav>
      <div class="section">
        <p class="muted">Modelo ativo:</p>
        <p id="activeModelPath">{{ active_model if active_model else 'Nenhum' }}</p>
      </div>
    </aside>
    <main class="content">
      <header class="row" style="justify-content: space-between;">
        <h1>{{ app_name }}</h1>
        <a class="btn secondary" href="/metrics" target="_blank">Ver M√©tricas</a>
      </header>

      <section class="cards">
        <div class="card">
          <h3>Webhook (n8n)</h3>
          <div class="value" style="font-size:14px;word-break:break-all;">{{ n8n_webhook if n8n_webhook else '‚Äî' }}</div>
          <div class="muted">Configure em <a href="/settings">Configura√ß√µes</a></div>
        </div>
        <div class="card">
          <h3>Jobs Ativos</h3>
          <div class="value">{{ jobs | length }}</div>
        </div>
        <div class="card">
          <h3>Detec√ß√µes Recentes</h3>
          <div class="value">{{ detections | length }}</div>
        </div>
      </section>

      <section class="section" id="inferenceUpload">
        <h2>Infer√™ncia (Upload)</h2>
        <form id="inferForm" class="form-row" onsubmit="return false;">
          <div class="form-group">
            <label for="inferImages">Imagens para Infer√™ncia</label>
            <input class="input" type="file" id="inferImages" name="inferImages" accept="image/*" multiple />
            <p class="muted">Selecione uma ou mais imagens</p>
          </div>
          <div class="form-group">
            <label for="registro">Registro (n√∫mero)</label>
            <input class="input" type="number" id="registro" name="registro" placeholder="Ex: 12345" />
          </div>
          <div class="form-group">
            <label for="ponto">Ponto (n√∫mero)</label>
            <input class="input" type="number" id="ponto" name="ponto" placeholder="Ex: 1" />
          </div>
          <div class="form-group">
            <label for="sheet_id">ID da Planilha</label>
            <input class="input" type="text" id="sheet_id" name="sheet_id" placeholder="Ex: 1AbCDef..." />
          </div>
          <div class="form-group">
            <label for="preproc_imgsz">Tamanho para Pr√©-processamento</label>
            <input class="input" type="number" id="preproc_imgsz" name="preproc_imgsz" value="{{ cfg.IMGSZ_DEFAULT }}" />
            <p class="muted">Imagens ser√£o redimensionadas (letterbox) para este tamanho quadrado</p>
          </div>
          <div class="form-group">
            <label class="checkbox-row">
              <input type="checkbox" id="send_webhook_now" />
              <span>Enviar diretamente para webhook n8n ap√≥s a infer√™ncia</span>
            </label>
          </div>
          <div class="form-group" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
            <button class="btn" type="button" onclick="preprocessSelectedImages()">Pr√©-processar</button>
            <button class="btn secondary" type="button" onclick="renameProcessedImages()">Renomear Imagens</button>
            <button class="btn" type="button" onclick="submitInference()">Enviar para Infer√™ncia (YOLO)</button>
            <button class="btn secondary" type="button" onclick="sendToN8N()">Enviar para Webhook (n8n)</button>
          </div>
          <div class="form-group">
            <p class="muted" id="inferStatus">Aguardando imagens...</p>
          </div>
        </form>
      </section>

      <section class="section">
        <h2>Treinamento (Upload)</h2>
        <form class="form-row" action="/panel/upload" method="post" enctype="multipart/form-data">
          <div class="form-group">
            <label for="dataset">Dataset YOLO (.zip)</label>
            <input class="input" type="file" name="dataset" id="dataset" accept=".zip,.yaml" required />
            <p class="muted">Arquivo .zip com estrutura YOLO (images/, labels/, classes.txt)</p>
          </div>
          
          <div class="form-group">
            <label for="epochs">√âpocas</label>
            <input class="input" type="number" name="epochs" id="epochs" value="50" />
            <p class="muted">N√∫mero de ciclos completos de treinamento</p>
          </div>
          
          <div class="form-group">
            <label for="imgsz">Tamanho da Imagem</label>
            <input class="input" type="number" name="imgsz" id="imgsz" value="640" />
            <p class="muted">Resolu√ß√£o de entrada (px)</p>
          </div>
          
          <div class="form-group">
            <label for="batch">Batch Size</label>
            <input class="input" type="number" name="batch" id="batch" value="16" />
            <p class="muted">N√∫mero de imagens por lote</p>
          </div>
          
          <div class="form-group">
            <label for="lr0">Taxa de Aprendizado</label>
            <input class="input" type="number" step="0.001" name="lr0" id="lr0" value="0.01" />
            <p class="muted">Learning rate inicial</p>
          </div>
          
          <div class="form-group">
            <label for="device">Dispositivo</label>
            <input class="input" type="text" name="device" id="device" placeholder="cpu/cuda:0" value="cpu" />
            <p class="muted">CPU ou GPU (cuda:0)</p>
          </div>
          
          <div class="form-group">
            <label class="checkbox-row">
              <input type="checkbox" name="resume" id="resume" />
              <span>Retomar Treinamento</span>
            </label>
            <p class="muted">Continuar de checkpoint anterior</p>
          </div>
          
          <div class="form-group">
            <label class="checkbox-row">
              <input type="checkbox" name="pretrained" id="pretrained" checked />
              <span>Usar Pesos Pr√©-treinados</span>
            </label>
            <p class="muted">Iniciar com pesos COCO</p>
          </div>
          
          <div class="form-group">
            <button class="btn train-btn" type="submit" id="trainBtn">
              <div class="btn-content">
                <svg class="btn-icon" viewBox="0 0 24 24">
                  <polygon points="5,3 19,12 5,21"/>
                </svg>
                <span class="btn-text">Iniciar Treinamento</span>
              </div>
              <div class="btn-loading" style="display: none;">
                <div class="loading-spinner"></div>
                <span>Iniciando...</span>
              </div>
            </button>
          </div>
        </form>
        <p class="muted">Envie .zip com dataset YOLO ou data.yaml.</p>
      </section>

      <section class="section" id="activeTraining" style="display: none;">
        <!-- Header com status proeminente -->
        <div class="training-header">
          <div class="training-status">
            <div class="status-indicator">
              <div class="pulse-dot"></div>
              <h2>üöÄ Treinamento em Andamento</h2>
            </div>
            <div class="overall-progress">
              <div class="progress-circle">
                <div class="progress-value" id="overallProgress">0%</div>
              </div>
            </div>
          </div>
          
          <!-- Bot√µes de controle do treinamento -->
          <div class="training-controls">
            <button class="btn-control pause" id="pauseBtn" onclick="pauseTraining()">
              <svg class="control-icon" viewBox="0 0 24 24">
                <rect x="6" y="4" width="4" height="16" rx="1"/>
                <rect x="14" y="4" width="4" height="16" rx="1"/>
              </svg>
              <span>Pausar</span>
            </button>
            <button class="btn-control resume" id="resumeBtn" onclick="resumeTraining()" style="display: none;">
              <svg class="control-icon" viewBox="0 0 24 24">
                <polygon points="5,3 19,12 5,21"/>
              </svg>
              <span>Retomar</span>
            </button>
            <button class="btn-control stop" id="stopBtn" onclick="stopTraining()">
              <svg class="control-icon" viewBox="0 0 24 24">
                <rect x="3" y="3" width="18" height="18" rx="2"/>
              </svg>
              <span>Parar</span>
            </button>
          </div>
        </div>

        <!-- Informa√ß√µes principais do treinamento -->
        <div class="training-overview">
          <div class="overview-card">
            <div class="overview-item">
              <span class="overview-label">üìä Job ID:</span>
              <span class="overview-value" id="activeJobId">-</span>
            </div>
            <div class="overview-item">
              <span class="overview-label">üìÅ Dataset:</span>
              <span class="overview-value" id="activeDataset">-</span>
            </div>
            <div class="overview-item">
              <span class="overview-label">‚è±Ô∏è Tempo:</span>
              <span class="overview-value" id="trainingTime">00:00:00</span>
            </div>
            <div class="overview-item">
              <span class="overview-label">üéØ √âpoca:</span>
              <span class="overview-value"><span id="currentEpoch">0</span>/<span id="totalEpochs">0</span></span>
            </div>
          </div>
        </div>

        <!-- Barra de progresso detalhada -->
        <div class="detailed-progress">
          <div class="progress-header">
            <span class="progress-title">Progresso do Treinamento</span>
            <span class="progress-percentage" id="epochPercentage">0%</span>
          </div>
          <div class="progress-bar-container">
            <!-- Barra percentual linear do treinamento -->
            <div class="progress-bar" aria-label="Progresso percentual do treinamento">
              <div class="progress" id="epochProgress" style="width: 0%"></div>
              <span class="progress-text" id="epochProgressText">0%</span>
            </div>
            <!-- Gr√°fico por √©poca -->
            <div class="progress-bar">
              <canvas id="progressBarChart" height="40"></canvas>
            </div>
          </div>
          <div class="progress-details">
            <span class="progress-detail">√âpoca <span id="currentEpochDetail">0</span> de <span id="totalEpochsDetail">0</span></span>
            <span class="progress-detail" id="trainingSpeed">- √©pocas/min</span>
          </div>
        </div>

        <!-- Monitoramento de recursos -->
        <div class="resource-monitoring">
          <h3>üìà Monitoramento de Recursos</h3>
          <div class="resource-grid">
            <div class="resource-card">
              <div class="resource-header">
                <span class="resource-icon">üñ•Ô∏è</span>
                <span class="resource-title">CPU</span>
              </div>
              <div class="resource-bar">
                <div class="resource-progress" id="cpuProgress"></div>
              </div>
              <div class="resource-value" id="cpuValue">0%</div>
            </div>
            <div class="resource-card">
              <div class="resource-header">
                <span class="resource-icon">üß†</span>
                <span class="resource-title">RAM</span>
              </div>
              <div class="resource-bar">
                <div class="resource-progress" id="ramProgress"></div>
              </div>
              <div class="resource-value" id="ramValue">0 GB</div>
            </div>
            <div class="resource-card">
              <div class="resource-header">
                <span class="resource-icon">‚ö°</span>
                <span class="resource-title">GPU</span>
              </div>
              <div class="resource-bar">
                <div class="resource-progress" id="gpuProgress"></div>
              </div>
              <div class="resource-value" id="gpuValue">N/A</div>
            </div>
          </div>
        </div>

        <!-- M√©tricas de performance -->
        <div class="performance-metrics">
          <h3>üìä M√©tricas de Performance</h3>
          <div class="metrics-grid">
            <div class="metric-card enhanced">
              <div class="metric-header">
                <h4>mAP50</h4>
                <div class="metric-trend" id="map50Trend">üìà</div>
              </div>
              <div class="metric-value" id="live_map50">-</div>
              <div class="metric-change" id="map50Change">-</div>
              <canvas id="live_map50Chart"></canvas>
            </div>
            <div class="metric-card enhanced">
              <div class="metric-header">
                <h4>mAP50-95</h4>
                <div class="metric-trend" id="map50_95Trend">üìà</div>
              </div>
              <div class="metric-value" id="live_map50_95">-</div>
              <div class="metric-change" id="map50_95Change">-</div>
              <canvas id="live_map50_95Chart"></canvas>
            </div>
            <div class="metric-card enhanced">
              <div class="metric-header">
                <h4>Box Loss</h4>
                <div class="metric-trend" id="boxLossTrend">üìâ</div>
              </div>
              <div class="metric-value" id="live_boxLoss">-</div>
              <div class="metric-change" id="boxLossChange">-</div>
              <canvas id="live_boxLossChart"></canvas>
            </div>
            <div class="metric-card enhanced">
              <div class="metric-header">
                <h4>Class Loss</h4>
                <div class="metric-trend" id="clsLossTrend">üìâ</div>
              </div>
              <div class="metric-value" id="live_clsLoss">-</div>
              <div class="metric-change" id="clsLossChange">-</div>
              <canvas id="live_clsLossChart"></canvas>
            </div>
          </div>
        </div>
      </section>

      <style>
        /* Estilos aprimorados para treinamento ativo */
        .training-header {
          background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
          border-radius: 12px;
          padding: 20px;
          margin-bottom: 20px;
          box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
          display: flex;
          justify-content: space-between;
          align-items: center;
        }

        .training-status {
          display: flex;
          justify-content: space-between;
          align-items: center;
          flex: 1;
        }

        .status-indicator {
          display: flex;
          align-items: center;
          gap: 12px;
        }

        .pulse-dot {
          width: 12px;
          height: 12px;
          background: #10b981;
          border-radius: 50%;
          animation: pulse 2s infinite;
        }

        @keyframes pulse {
          0% { transform: scale(1); opacity: 1; }
          50% { transform: scale(1.2); opacity: 0.7; }
          100% { transform: scale(1); opacity: 1; }
        }

        .training-status h2 {
          margin: 0;
          color: white;
          font-size: 24px;
          font-weight: 600;
        }

        .overall-progress {
          display: flex;
          align-items: center;
        }

        .progress-circle {
          width: 60px;
          height: 60px;
          border-radius: 50%;
          background: conic-gradient(#10b981 0deg, #374151 0deg);
          display: flex;
          align-items: center;
          justify-content: center;
          position: relative;
        }

        .progress-circle::before {
          content: '';
          width: 45px;
          height: 45px;
          border-radius: 50%;
          background: #1e3a8a;
          position: absolute;
        }

        /* Bot√µes de controle do treinamento */
        .training-controls {
          display: flex;
          gap: 12px;
          margin-left: 20px;
        }

        .btn-control {
          display: flex;
          align-items: center;
          gap: 8px;
          padding: 10px 16px;
          border: none;
          border-radius: 8px;
          font-size: 14px;
          font-weight: 500;
          cursor: pointer;
          transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
          backdrop-filter: blur(10px);
          position: relative;
          overflow: hidden;
        }

        .btn-control::before {
          content: '';
          position: absolute;
          top: 0;
          left: -100%;
          width: 100%;
          height: 100%;
          background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
          transition: left 0.5s;
        }

        .btn-control:hover::before {
          left: 100%;
        }

        .btn-control.pause {
          background: rgba(251, 191, 36, 0.2);
          color: #fbbf24;
          border: 1px solid rgba(251, 191, 36, 0.3);
        }

        .btn-control.pause:hover {
          background: rgba(251, 191, 36, 0.3);
          transform: translateY(-2px);
          box-shadow: 0 8px 25px rgba(251, 191, 36, 0.3);
        }

        .btn-control.resume {
          background: rgba(34, 197, 94, 0.2);
          color: #22c55e;
          border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .btn-control.resume:hover {
          background: rgba(34, 197, 94, 0.3);
          transform: translateY(-2px);
          box-shadow: 0 8px 25px rgba(34, 197, 94, 0.3);
        }

        .btn-control.stop {
          background: rgba(239, 68, 68, 0.2);
          color: #ef4444;
          border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .btn-control.stop:hover {
          background: rgba(239, 68, 68, 0.3);
          transform: translateY(-2px);
          box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3);
        }

        .control-icon {
          width: 16px;
          height: 16px;
          fill: currentColor;
        }

        /* Bot√£o de treinamento animado */
        .train-btn {
          position: relative;
          overflow: hidden;
          background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
          border: none;
          color: white;
          padding: 16px 32px;
          border-radius: 12px;
          font-size: 16px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
          box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
          min-width: 200px;
        }

        .train-btn:hover {
          transform: translateY(-2px);
          box-shadow: 0 8px 25px rgba(59, 130, 246, 0.5);
        }

        .train-btn:active {
          transform: translateY(0);
        }

        .btn-content {
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 10px;
        }

        .btn-icon {
          width: 20px;
          height: 20px;
          fill: currentColor;
          transition: transform 0.3s ease;
        }

        .train-btn:hover .btn-icon {
          transform: scale(1.1);
        }

        .btn-loading {
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 10px;
        }

        .loading-spinner {
          width: 20px;
          height: 20px;
          border: 2px solid rgba(255, 255, 255, 0.3);
          border-top: 2px solid white;
          border-radius: 50%;
          animation: spin 1s linear infinite;
        }

        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }

        .train-btn.loading {
          pointer-events: none;
          opacity: 0.8;
        }

        .train-btn.loading .btn-content {
          display: none;
        }

        .train-btn.loading .btn-loading {
          display: flex;
        }

        .progress-value {
          color: white;
          font-weight: 600;
          font-size: 12px;
          z-index: 1;
        }

        .training-overview {
          background: #161b22;
          border: 1px solid #30363d;
          border-radius: 8px;
          padding: 20px;
          margin-bottom: 20px;
        }

        .overview-card {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 15px;
        }

        .overview-item {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 12px;
          background: #0d1117;
          border-radius: 6px;
          border-left: 3px solid #3b82f6;
        }

        .overview-label {
          color: #ffffff;
          font-size: 14px;
          font-weight: 500;
        }

        .overview-value {
          color: #ffffff;
          font-weight: 600;
        }

        .detailed-progress {
          background: #161b22;
          border: 1px solid #30363d;
          border-radius: 8px;
          padding: 20px;
          margin-bottom: 20px;
        }

        .progress-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 12px;
        }

        .progress-title {
          color: #ffffff;
          font-weight: 600;
          font-size: 16px;
        }

        .progress-percentage {
          color: #3b82f6;
          font-weight: 700;
          font-size: 18px;
        }

        .progress-bar-container {
          margin-bottom: 12px;
        }

        .progress-bar {
          background: #0d1117;
          border-radius: 8px;
          height: 12px;
          position: relative;
          overflow: hidden;
        }

        .progress {
          background: linear-gradient(90deg, #3b82f6, #10b981);
          height: 100%;
          width: 0%;
          transition: width 0.5s ease;
          border-radius: 8px;
        }

        .progress-details {
          display: flex;
          justify-content: space-between;
          color: #ffffff;
          font-size: 14px;
        }

        .resource-monitoring {
          background: #161b22;
          border: 1px solid #30363d;
          border-radius: 8px;
          padding: 20px;
          margin-bottom: 20px;
        }

        .resource-monitoring h3 {
          margin: 0 0 15px 0;
          color: #ffffff;
          font-size: 18px;
        }

        .resource-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 15px;
        }

        .resource-card {
          background: #0d1117;
          border-radius: 8px;
          padding: 15px;
          border: 1px solid #21262d;
        }

        .resource-header {
          display: flex;
          align-items: center;
          gap: 8px;
          margin-bottom: 10px;
        }

        .resource-icon {
          font-size: 18px;
        }

        .resource-title {
          color: #ffffff;
          font-weight: 600;
        }

        .resource-bar {
          background: #21262d;
          border-radius: 4px;
          height: 8px;
          margin-bottom: 8px;
          overflow: hidden;
        }

        .resource-progress {
          height: 100%;
          border-radius: 4px;
          transition: width 0.3s ease;
        }

        .resource-card:nth-child(1) .resource-progress {
          background: #f59e0b;
        }

        .resource-card:nth-child(2) .resource-progress {
          background: #10b981;
        }

        .resource-card:nth-child(3) .resource-progress {
          background: #8b5cf6;
        }

        .resource-value {
          color: #ffffff;
          font-weight: 600;
          text-align: center;
        }

        .performance-metrics {
          background: #161b22;
          border: 1px solid #30363d;
          border-radius: 8px;
          padding: 20px;
        }

        .performance-metrics h3 {
          margin: 0 0 15px 0;
          color: #ffffff;
          font-size: 18px;
        }

        .metric-card.enhanced {
          background: #0d1117;
          border: 1px solid #21262d;
          border-radius: 8px;
          padding: 15px;
          position: relative;
          transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .metric-card.enhanced:hover {
          transform: translateY(-2px);
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .metric-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 8px;
        }

        .metric-header h4 {
          margin: 0;
          color: #ffffff;
          font-size: 14px;
          font-weight: 600;
        }

        .metric-trend {
          font-size: 16px;
        }

        .metric-change {
          font-size: 12px;
          font-weight: 500;
          margin-bottom: 8px;
        }

        .metric-change.positive {
          color: #10b981;
        }

        .metric-change.negative {
          color: #ef4444;
        }

        .metric-change.neutral {
          color: #ffffff;
        }

        /* Estilos existentes mantidos */
        .training-info {
          background: #161b22;
          border: 1px solid #30363d;
          border-radius: 8px;
          padding: 15px;
          margin-top: 15px;
        }
        .training-stats {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 10px;
        }
        .stat {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 8px;
          background: #0d1117;
          border-radius: 4px;
        }
        .stat-label {
          color: #ffffff;
          font-size: 14px;
        }
        .stat-value {
          font-weight: 500;
        }
      </style>

      <section class="section">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
          <h2>Jobs</h2>
          <button class="btn secondary" id="clearJobsBtn" onclick="clearJobs()">Limpar Hist√≥rico</button>
        </div>
        <table class="table">
          <thead>
            <tr>
              <th>Job</th>
              <th>Status</th>
              <th>Best.pt</th>
              <th>Iniciado</th>
              <th>Finalizado</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody>
          {% for job in jobs %}
            <tr>
              <td>{{ job.job_id }}</td>
              <td>
                {% if job.status == 'running' %}<span class="pill warn">{{ job.status }}</span>{% elif job.status == 'completed' %}<span class="pill ok">{{ job.status }}</span>{% else %}{{ job.status }}{% endif %}
              </td>
              <td>{{ job.best_pt if job.best_pt else '‚Äî' }}</td>
              <td>{{ job.started_at }}</td>
              <td>{{ job.finished_at if job.finished_at else '‚Äî' }}</td>
              <td>
                <button class="btn secondary small" onclick="showMetrics('{{ job.job_id }}')">M√©tricas</button>
                <button class="btn small" style="background:#2563eb;border-color:#2563eb;" onclick="promoteJob('{{ job.job_id }}', '{{ job.best_pt if job.best_pt else '' }}', this)">Ativar</button>
                {% if job.status == 'running' %}
                <button class="btn warn small" onclick="setCurrentJobAndPause('{{ job.job_id }}')">Pausar</button>
                <button class="btn danger small" onclick="setCurrentJobAndStop('{{ job.job_id }}')">Parar</button>
                {% elif job.status == 'paused' %}
                <button class="btn ok small" onclick="setCurrentJobAndResume('{{ job.job_id }}')">Retomar</button>
                <button class="btn danger small" onclick="setCurrentJobAndStop('{{ job.job_id }}')">Parar</button>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </section>

      <!-- Modal de M√©tricas -->
      <div id="metricsModal" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h3>M√©tricas de Treinamento</h3>
            <button class="close-btn" onclick="closeMetrics()">&times;</button>
          </div>
          <div class="modal-body">
            <div class="metrics-grid">
              <div class="metric-card">
                <h4>mAP50</h4>
                <div class="metric-value" id="map50">-</div>
                <canvas id="map50Chart"></canvas>
              </div>
              <div class="metric-card">
                <h4>mAP50-95</h4>
                <div class="metric-value" id="map50_95">-</div>
                <canvas id="map50_95Chart"></canvas>
              </div>
              <div class="metric-card">
                <h4>Box Loss</h4>
                <div class="metric-value" id="boxLoss">-</div>
                <canvas id="boxLossChart"></canvas>
              </div>
              <div class="metric-card">
                <h4>Class Loss</h4>
                <div class="metric-value" id="clsLoss">-</div>
                <canvas id="clsLossChart"></canvas>
              </div>
            </div>
            <div class="metrics-table">
              <h4>M√©tricas por Classe</h4>
              <table class="table">
                <thead>
                  <tr>
                    <th>Classe</th>
                    <th>Precision</th>
                    <th>Recall</th>
                    <th>mAP50</th>
                    <th>mAP50-95</th>
                  </tr>
                </thead>
                <tbody id="classMetrics">
                  <tr><td colspan="5">Selecione um job para ver as m√©tricas</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <style>
        .modal {
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0,0,0,0.8);
          z-index: 1000;
        }
        .modal-content {
          background: #0d1117;
          margin: 5% auto;
          padding: 20px;
          width: 90%;
          max-width: 1200px;
          border-radius: 8px;
          border: 1px solid #30363d;
        }
        .modal-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 20px;
          padding-bottom: 10px;
          border-bottom: 1px solid #30363d;
        }
        .close-btn {
          background: none;
          border: none;
          color: #ffffff;
          font-size: 24px;
          cursor: pointer;
        }
        .metrics-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
          gap: 20px;
          margin-bottom: 20px;
        }
        .metric-card {
          background: #161b22;
          padding: 15px;
          border-radius: 8px;
          border: 1px solid #30363d;
        }
        .metric-value {
          font-size: 24px;
          font-weight: bold;
          margin: 10px 0;
        }
        .metrics-table {
          background: #161b22;
          padding: 15px;
          border-radius: 8px;
          border: 1px solid #30363d;
        }
        .btn.small {
          padding: 4px 8px;
          font-size: 12px;
        }
      </style>

      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
      <script>
        // Vari√°veis globais para gr√°ficos
        const allCharts = {
          modal: {},
          live: {},
          system: {
            network: null
          }
        };
        let activeJobId = null;
        let updateInterval = null;
        let startTime = null;
        let systemUpdateInterval = null;
        
        function createChart(ctx, label) {
          // Verificar se j√° existe um gr√°fico neste canvas
          const existingChart = Chart.getChart(ctx.canvas);
          if (existingChart) {
            existingChart.destroy();
          }
          
          return new Chart(ctx, {
            type: 'line',
            data: {
              labels: [],
              datasets: [{
                label: label,
                data: [],
                borderColor: '#2563eb',
                tension: 0.1
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                y: {
                  beginAtZero: true,
                  grid: {
                    color: '#30363d'
                  },
                  ticks: {
                    color: '#ffffff'
                  }
                },
                x: {
                  grid: {
                    color: '#30363d'
                  },
                  ticks: {
                    color: '#ffffff'
                  }
                }
              },
              plugins: {
                legend: {
                  display: false
                }
              }
            }
          });
        }
        
        // Inicializar gr√°fico de rede
        function initNetworkChart() {
          const ctx = document.getElementById('networkChart');
          if (!ctx) return;
          
          // Destruir gr√°fico existente se houver
          if (allCharts.system.network) allCharts.system.network.destroy();
          
          allCharts.system.network = new Chart(ctx, {
            type: 'line',
            data: {
              labels: [],
              datasets: [
                {
                  label: 'Upload',
                  data: [],
                  borderColor: '#2563eb',
                  backgroundColor: 'rgba(37, 99, 235, 0.1)',
                  fill: true,
                  tension: 0.4
                },
                {
                  label: 'Download',
                  data: [],
                  borderColor: '#8b5cf6',
                  backgroundColor: 'rgba(139, 92, 246, 0.1)',
                  fill: true,
                  tension: 0.4
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              interaction: {
                intersect: false,
                mode: 'index'
              },
              scales: {
                y: {
                  beginAtZero: true,
                  grid: {
                    color: '#30363d'
                  },
                  ticks: {
                    color: '#ffffff'
                  }
                },
                x: {
                  grid: {
                    color: '#30363d'
                  },
                  ticks: {
                    color: '#ffffff',
                    maxRotation: 0
                  }
                }
              },
              plugins: {
                legend: {
                  display: true,
                  position: 'top',
                  labels: {
                    color: '#ffffff'
                  }
                }
              }
            }
          });
        }
        
        function initCharts() {
          // Limpar gr√°ficos existentes
          Object.values(allCharts.modal).forEach(chart => {
            if (chart) chart.destroy();
          });
          Object.values(allCharts.live).forEach(chart => {
            if (chart) chart.destroy();
          });
          if (allCharts.system.network) allCharts.system.network.destroy();
          
          allCharts.modal = {};
          allCharts.live = {};
          allCharts.system.network = null;
          
          // Inicializar gr√°ficos do modal
          const modalMetrics = ['map50', 'map50_95', 'boxLoss', 'clsLoss'];
          modalMetrics.forEach(metric => {
            const canvas = document.getElementById(metric + 'Chart');
            if (canvas) {
              allCharts.modal[metric] = createChart(canvas.getContext('2d'), metric);
            }
          });
          
          // Inicializar gr√°ficos ao vivo
          const liveMetrics = ['map50', 'map50_95', 'boxLoss', 'clsLoss'];
          liveMetrics.forEach(metric => {
            const canvas = document.getElementById('live_' + metric + 'Chart');
            if (canvas) {
              allCharts.live[metric] = createChart(canvas.getContext('2d'), metric);
            }
          });
          
          // Inicializar gr√°fico de rede
          initNetworkChart();
        }
        
        // Atualizar dados do sistema
        async function updateSystemStats() {
          try {
            const response = await fetch('/system/stats');
            const data = await response.json();
            
            // Atualizar CPU
            const cpuProgress = document.getElementById('cpuProgress');
            const cpuModel = document.getElementById('cpuModel');
            const cpuSpeed = document.getElementById('cpuSpeed');
            const cpuCores = document.getElementById('cpuCores');
            
            if (cpuProgress) {
              cpuProgress.style.width = `${data.cpu.usage}%`;
              const cpuPercentageElement = cpuProgress.nextElementSibling;
              if (cpuPercentageElement) cpuPercentageElement.textContent = `${data.cpu.usage}%`;
            }
            if (cpuModel) cpuModel.textContent = data.cpu.model;
            if (cpuSpeed) cpuSpeed.textContent = data.cpu.speed;
            if (cpuCores) cpuCores.textContent = data.cpu.cores;
            
            // Atualizar RAM
            const ramProgress = document.getElementById('ramProgress');
            const ramUsage = document.getElementById('ramUsage');
            const ramSpeed = document.getElementById('ramSpeed');
            const ramType = document.getElementById('ramType');
            
            if (ramProgress) {
              ramProgress.style.width = `${data.ram.usage}%`;
              const ramPercentageElement = ramProgress.nextElementSibling;
              if (ramPercentageElement) ramPercentageElement.textContent = `${data.ram.usage}%`;
            }
            if (ramUsage) ramUsage.textContent = data.ram.total;
            if (ramSpeed) ramSpeed.textContent = data.ram.speed;
            if (ramType) ramType.textContent = data.ram.type;
            
            // Atualizar HDD
            const hddProgress = document.getElementById('hddProgress');
            const hddModel = document.getElementById('hddModel');
            const hddType = document.getElementById('hddType');
            const hddCapacity = document.getElementById('hddCapacity');
            
            if (hddProgress) {
              hddProgress.style.width = `${data.hdd.usage}%`;
              const hddPercentageElement = hddProgress.nextElementSibling;
              if (hddPercentageElement) hddPercentageElement.textContent = `${data.hdd.usage}%`;
            }
            if (hddModel) hddModel.textContent = data.hdd.model;
            if (hddType) hddType.textContent = data.hdd.type;
            if (hddCapacity) hddCapacity.textContent = data.hdd.capacity;
            
            // Atualizar informa√ß√µes do sistema
            const systemIp = document.getElementById('systemIp');
            const systemOs = document.getElementById('systemOs');
            const panelVersion = document.getElementById('panelVersion');
            const systemStatus = document.getElementById('systemStatus');
            const systemUptime = document.getElementById('systemUptime');
            
            if (systemIp) systemIp.textContent = data.system.ip;
            if (systemOs) systemOs.textContent = data.system.os;
            if (panelVersion) panelVersion.textContent = data.system.version;
            if (systemStatus) systemStatus.textContent = data.system.status;
            if (systemUptime) systemUptime.textContent = data.system.uptime;
            
            // Atualizar gr√°fico de rede
            if (allCharts.system.network) {
              const now = new Date();
              const timeStr = now.toLocaleTimeString();
              
              const chart = allCharts.system.network;
              chart.data.labels.push(timeStr);
              chart.data.datasets[0].data.push(data.network.upload);
              chart.data.datasets[1].data.push(data.network.download);
              
              // Manter apenas os √∫ltimos 20 pontos
              if (chart.data.labels.length > 20) {
                chart.data.labels.shift();
                chart.data.datasets[0].data.shift();
                chart.data.datasets[1].data.shift();
              }
              
              chart.update();
            }
          } catch (error) {
            console.error('Erro ao atualizar estat√≠sticas:', error);
          }
        }
        
        // Alternar modo tela cheia
        function toggleFullscreen(button) {
          const card = button.closest('.network-traffic, .stat-card');
          card.classList.toggle('fullscreen');
          
          if (card.classList.contains('network-traffic') && allCharts.system.network) {
            allCharts.system.network.resize();
          }
        }
        
        // Fun√ß√µes para treinamento
        function updateTrainingTime() {
          if (!startTime) return;
          const now = new Date();
          const diff = Math.floor((now - startTime) / 1000);
          const hours = Math.floor(diff / 3600);
          const minutes = Math.floor((diff % 3600) / 60);
          const seconds = diff % 60;
          const timeElement = document.getElementById('trainingTime');
          if (timeElement) {
            timeElement.textContent = 
              `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
          }
        }
        
        async function checkActiveTraining() {
          try {
            const auth = getAuthHeader();
            const response = await fetch('/train/active', {
              headers: auth ? { 'Authorization': auth } : {}
            });
            
            const activeTraining = document.getElementById('activeTraining');
            if (!activeTraining) return;
            
            if (!response.ok) {
              // Nenhum treinamento ativo (404 ou outro erro)
              activeTraining.style.display = 'none';
              activeJobId = null;
              startTime = null;
              return;
            }
            
            const data = await response.json();
            
            if (data.active_job) {
              const jobId = data.active_job.job_id;
              activeTraining.style.display = 'block';
              // Sincronizar jobId global utilizado pelos bot√µes
              currentActiveJobId = jobId;

              // Alternar bot√µes conforme status do job
              const status = data.active_job.status || 'running';
              const pauseBtn = document.getElementById('pauseBtn');
              const resumeBtn = document.getElementById('resumeBtn');
              const pulseDot = document.querySelector('.pulse-dot');
              if (pauseBtn && resumeBtn) {
                if (status === 'paused') {
                  pauseBtn.style.display = 'none';
                  resumeBtn.style.display = 'flex';
                  if (pulseDot) pulseDot.style.background = '#f59e0b';
                } else {
                  pauseBtn.style.display = 'flex';
                  resumeBtn.style.display = 'none';
                  if (pulseDot) pulseDot.style.background = '#10b981';
                }
              }
              
              if (jobId !== activeJobId) {
                // Novo job iniciado
                activeJobId = jobId;
                startTime = new Date(data.active_job.started_at);
                
                const jobIdElement = document.getElementById('activeJobId');
                const datasetElement = document.getElementById('activeDataset');
                const totalEpochsElement = document.getElementById('totalEpochs');
                const totalEpochsDetailElement = document.getElementById('totalEpochsDetail');
                
                if (jobIdElement) jobIdElement.textContent = jobId;
                if (datasetElement) datasetElement.textContent = data.active_job.dataset_name || 'Dataset';
                if (totalEpochsElement) totalEpochsElement.textContent = data.active_job.total_epochs || '?';
                if (totalEpochsDetailElement) totalEpochsDetailElement.textContent = data.active_job.total_epochs || '?';
                
                // Inicializar gr√°fico de progresso
                const progressCtx = document.getElementById('progressBarChart')?.getContext('2d');
                if (progressCtx) {
                  if (progressChart) progressChart.destroy();
                  const totalEpochs = data.active_job.total_epochs || 0;
                  const labels = Array.from({ length: totalEpochs }, (_, i) => i + 1);
                  progressChart = new Chart(progressCtx, {
                    type: 'bar',
                    data: {
                      labels,
                      datasets: [{
                        label: 'Progresso por √âpoca',
                        data: labels.map(l => (l <= (data.active_job.metrics && data.active_job.metrics.epochs ? data.active_job.metrics.epochs : 0) ? 1 : 0)),
                         backgroundColor: labels.map(l => (l <= (data.active_job.metrics && data.active_job.metrics.epochs ? data.active_job.metrics.epochs : 0) ? 'rgba(16, 185, 129, 0.7)' : 'rgba(55, 65, 81, 0.5)')),
                         borderRadius: 4
                      }]
                    },
                    options: {
                      responsive: true,
                      maintainAspectRatio: false,
                      plugins: { legend: { display: false } },
                      scales: {
                        x: { ticks: { color: '#fff' } },
                        y: { display: false, suggestedMax: 1 }
                      }
                    }
                  });
                }
              }
              
              // Atualizar m√©tricas apenas se existirem
              if (data.active_job.metrics && data.active_job.metrics.metrics) {
                const metrics = data.active_job.metrics;
                
                // Valores atuais - verificar se existem antes de usar
                const map50Element = document.getElementById('live_map50');
                const map50_95Element = document.getElementById('live_map50_95');
                const boxLossElement = document.getElementById('live_boxLoss');
                const clsLossElement = document.getElementById('live_clsLoss');
                
                if (map50Element && metrics.metrics.mAP50 !== undefined) {
                  map50Element.textContent = (metrics.metrics.mAP50 * 100).toFixed(2) + '%';
                }
                if (map50_95Element && metrics.metrics.mAP50_95 !== undefined) {
                  map50_95Element.textContent = (metrics.metrics.mAP50_95 * 100).toFixed(2) + '%';
                }
                if (boxLossElement && metrics.train_box_loss !== undefined) {
                  boxLossElement.textContent = metrics.train_box_loss.toFixed(3);
                }
                if (clsLossElement && metrics.train_cls_loss !== undefined) {
                  clsLossElement.textContent = metrics.train_cls_loss.toFixed(3);
                }
                
                // Atualizar tend√™ncias das m√©tricas
                updateMetricTrends(metrics);
                
                // Progresso
                const currentEpoch = metrics.epochs || 0;
                const totalEpochs = data.active_job.total_epochs || 0;
                const progressPercentage = totalEpochs > 0 ? (currentEpoch / totalEpochs * 100) : 0;
                
                // Atualizar elementos de progresso
                const currentEpochElement = document.getElementById('currentEpoch');
                const currentEpochDetailElement = document.getElementById('currentEpochDetail');
                const epochProgressElement = document.getElementById('epochProgress');
                const epochPercentageElement = document.getElementById('epochPercentage');
                const overallProgressElement = document.getElementById('overallProgress');
                const epochProgressTextElement = document.getElementById('epochProgressText');
                
                if (currentEpochElement) currentEpochElement.textContent = currentEpoch;
                if (currentEpochDetailElement) currentEpochDetailElement.textContent = currentEpoch;
                if (epochProgressElement) epochProgressElement.style.width = `${progressPercentage}%`;
                if (epochPercentageElement) epochPercentageElement.textContent = `${progressPercentage.toFixed(1)}%`;
                if (overallProgressElement) overallProgressElement.textContent = `${progressPercentage.toFixed(0)}%`;
                if (epochProgressTextElement) epochProgressTextElement.textContent = `${progressPercentage.toFixed(1)}%`;
                
                // Atualizar c√≠rculo de progresso
                updateProgressCircle(progressPercentage);
                
                // Atualizar gr√°fico de progresso
                if (progressChart) {
                  const totalEpochs = data.active_job.total_epochs || 0;
                  const labels = Array.from({ length: totalEpochs }, (_, i) => i + 1);
                  progressChart.data.labels = labels;
                  progressChart.data.datasets[0].data = labels.map(l => (l <= currentEpoch ? 1 : 0));
                  progressChart.data.datasets[0].backgroundColor = labels.map(l => (
                    l <= currentEpoch ? 'rgba(16, 185, 129, 0.7)' : 'rgba(55, 65, 81, 0.5)'
                  ));
                  progressChart.update();
                  
                  // Atualizar velocidade de treinamento
                  updateTrainingSpeed(currentEpoch);
                }
              }
              
              // Atualizar tempo e recursos
              updateTrainingTime();
              updateResourceMonitoring();
              
            } else {
              // Nenhum treinamento ativo
              activeTraining.style.display = 'none';
              activeJobId = null;
              startTime = null;
            }
          } catch (error) {
            console.error('Erro ao verificar treinamento ativo:', error);
          }
        }

        // Fun√ß√£o para atualizar tend√™ncias das m√©tricas
        function updateMetricTrends(metrics) {
          const trends = {
            map50: calculateTrend(metrics.metrics.mAP50_per_epoch),
            map50_95: calculateTrend(metrics.metrics.mAP50_95_per_epoch),
            boxLoss: calculateTrend(metrics.box_loss_per_epoch, true), // true = menor √© melhor
            clsLoss: calculateTrend(metrics.cls_loss_per_epoch, true)
          };

          // Atualizar √≠cones de tend√™ncia
          Object.entries(trends).forEach(([metric, trend]) => {
            const trendElement = document.getElementById(`${metric}Trend`);
            const changeElement = document.getElementById(`${metric}Change`);
            
            if (trendElement) {
              trendElement.textContent = trend.icon;
            }
            
            if (changeElement) {
              changeElement.textContent = trend.text;
              changeElement.className = `metric-change ${trend.class}`;
            }
          });
        }

        // Fun√ß√£o para calcular tend√™ncia
        function calculateTrend(data, lowerIsBetter = false) {
          if (!data || data.length < 2) {
            return { icon: '‚ûñ', text: 'N/A', class: 'neutral' };
          }

          const recent = data.slice(-3); // √öltimas 3 √©pocas
          const change = recent[recent.length - 1] - recent[0];
          const percentChange = Math.abs(change / recent[0] * 100);

          let icon, className;
          if (Math.abs(change) < 0.001) {
            icon = '‚ûñ';
            className = 'neutral';
          } else if ((change > 0 && !lowerIsBetter) || (change < 0 && lowerIsBetter)) {
            icon = 'üìà';
            className = 'positive';
          } else {
            icon = 'üìâ';
            className = 'negative';
          }

          const sign = change > 0 ? '+' : '';
          const text = `${sign}${(change * (lowerIsBetter ? 1 : 100)).toFixed(3)}${lowerIsBetter ? '' : '%'}`;

          return { icon, text, class: className };
        }

        // Fun√ß√£o para atualizar c√≠rculo de progresso
        function updateProgressCircle(percentage) {
          const progressCircle = document.querySelector('.progress-circle');
          if (progressCircle) {
            const degrees = (percentage / 100) * 360;
            progressCircle.style.background = `conic-gradient(#10b981 ${degrees}deg, #374151 ${degrees}deg)`;
          }
        }

        // Fun√ß√£o para calcular velocidade de treinamento
        let lastEpochTime = null;
        let lastEpochNum = null;
        let epochTimes = [];

        function updateTrainingSpeed(currentEpoch) {
          const now = Date.now();
          
          // Atualiza velocidade apenas quando a √©poca aumenta
          if (lastEpochNum !== null && currentEpoch > lastEpochNum) {
            const epochDuration = (now - (lastEpochTime || now)) / 1000 / 60; // minutos
            epochTimes.push(epochDuration);
            
            // Manter apenas as √∫ltimas 5 √©pocas para c√°lculo da m√©dia
            if (epochTimes.length > 5) {
              epochTimes.shift();
            }
            
            const avgEpochTime = epochTimes.reduce((a, b) => a + b, 0) / epochTimes.length;
            const epochsPerMin = avgEpochTime > 0 ? (1 / avgEpochTime) : 0;
            
            const speedElement = document.getElementById('trainingSpeed');
            if (speedElement) {
              speedElement.textContent = `${epochsPerMin.toFixed(2)} √©pocas/min`;
            }
          }
          
          lastEpochTime = now;
          lastEpochNum = currentEpoch;
        }

        // Fun√ß√£o para monitoramento de recursos (simulado)
        async function updateResourceMonitoring() {
          try {
            // Simular dados de recursos (em produ√ß√£o, isso viria de uma API)
            const cpuUsage = Math.random() * 80 + 10; // 10-90%
            const ramUsage = Math.random() * 60 + 20; // 20-80%
            const gpuUsage = Math.random() * 90 + 5;  // 5-95%

            // Atualizar CPU
            const cpuProgress = document.getElementById('cpuProgress');
            const cpuValue = document.getElementById('cpuValue');
            if (cpuProgress) cpuProgress.style.width = `${cpuUsage}%`;
            if (cpuValue) cpuValue.textContent = `${cpuUsage.toFixed(1)}%`;

            // Atualizar RAM
            const ramProgress = document.getElementById('ramProgress');
            const ramValue = document.getElementById('ramValue');
            const ramGB = (ramUsage / 100) * 16; // Simular 16GB total
            if (ramProgress) ramProgress.style.width = `${ramUsage}%`;
            if (ramValue) ramValue.textContent = `${ramGB.toFixed(1)} GB`;

            // Atualizar GPU
            const gpuProgress = document.getElementById('gpuProgress');
            const gpuValue = document.getElementById('gpuValue');
            if (gpuProgress) gpuProgress.style.width = `${gpuUsage}%`;
            if (gpuValue) gpuValue.textContent = `${gpuUsage.toFixed(1)}%`;

          } catch (error) {
            console.error('Erro ao atualizar recursos:', error);
          }
        }
        
        async function showMetrics(jobId) {
          const modal = document.getElementById('metricsModal');
          if (!modal) return;
          modal.style.display = 'block';
          
          // Limpar m√©tricas anteriores
          const elements = {
            map50: document.getElementById('map50'),
            map50_95: document.getElementById('map50_95'),
            boxLoss: document.getElementById('boxLoss'),
            clsLoss: document.getElementById('clsLoss'),
            classMetrics: document.getElementById('classMetrics')
          };
          
          if (elements.map50) elements.map50.textContent = '-';
          if (elements.map50_95) elements.map50_95.textContent = '-';
          if (elements.boxLoss) elements.boxLoss.textContent = '-';
          if (elements.clsLoss) elements.clsLoss.textContent = '-';
          if (elements.classMetrics) elements.classMetrics.innerHTML = '<tr><td colspan="5">Carregando m√©tricas...</td></tr>';
          
          try {
            const response = await fetch(`/train/${jobId}`);
            const data = await response.json();
            
            if (data.metrics) {
              // Atualizar valores
              if (elements.map50) elements.map50.textContent = (data.metrics.metrics.mAP50 * 100).toFixed(2) + '%';
              if (elements.map50_95) elements.map50_95.textContent = (data.metrics.metrics.mAP50_95 * 100).toFixed(2) + '%';
              if (elements.boxLoss) elements.boxLoss.textContent = data.metrics.train_box_loss.toFixed(3);
              if (elements.clsLoss) elements.clsLoss.textContent = data.metrics.train_cls_loss.toFixed(3);
              
              // Atualizar gr√°ficos
              const epochs = Array.from({length: data.metrics.epochs}, (_, i) => i + 1);
              
              Object.entries({
                map50: data.metrics.metrics.mAP50_per_epoch,
                map50_95: data.metrics.metrics.mAP50_95_per_epoch,
                boxLoss: data.metrics.box_loss_per_epoch,
                clsLoss: data.metrics.cls_loss_per_epoch
              }).forEach(([metric, chartData]) => {
                const chart = allCharts.modal[metric];
                if (chart) {
                  chart.data.labels = epochs;
                  chart.data.datasets[0].data = chartData;
                  chart.update();
                }
              });
              
              // Atualizar m√©tricas por classe
              if (elements.classMetrics) {
                let classMetricsHtml = '';
                Object.entries(data.metrics.metrics.per_class).forEach(([className, metrics]) => {
                  classMetricsHtml += `
                    <tr>
                      <td>${className}</td>
                      <td>${(metrics.precision * 100).toFixed(2)}%</td>
                      <td>${(metrics.recall * 100).toFixed(2)}%</td>
                      <td>${(metrics.mAP50 * 100).toFixed(2)}%</td>
                      <td>${(metrics.mAP50_95 * 100).toFixed(2)}%</td>
                    </tr>
                  `;
                });
                elements.classMetrics.innerHTML = classMetricsHtml;
              }
            } else if (elements.classMetrics) {
              elements.classMetrics.innerHTML = '<tr><td colspan="5">M√©tricas n√£o dispon√≠veis</td></tr>';
            }
          } catch (error) {
            console.error('Erro ao carregar m√©tricas:', error);
            if (elements.classMetrics) {
              elements.classMetrics.innerHTML = '<tr><td colspan="5">Erro ao carregar m√©tricas</td></tr>';
            }
          }
        }
        
        function closeMetrics() {
          const modal = document.getElementById('metricsModal');
          if (modal) modal.style.display = 'none';
        }
        
        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
          // Inicializar gr√°ficos
          initCharts();
          
          // Verificar treinamento ativo a cada 5 segundos
          updateInterval = setInterval(checkActiveTraining, 5000);
          // Atualizar tempo a cada segundo
          setInterval(updateTrainingTime, 1000);
          // Atualizar estat√≠sticas do sistema a cada 2 segundos
          systemUpdateInterval = setInterval(updateSystemStats, 2000);
          
          // Primeiras verifica√ß√µes
          checkActiveTraining();
          updateSystemStats();
        });
        
        // Limpar intervalos ao sair da p√°gina
        window.addEventListener('beforeunload', () => {
          if (updateInterval) clearInterval(updateInterval);
          if (systemUpdateInterval) clearInterval(systemUpdateInterval);
          
          // Destruir todos os gr√°ficos
          Object.values(allCharts.modal).forEach(chart => {
            if (chart) chart.destroy();
          });
          Object.values(allCharts.live).forEach(chart => {
            if (chart) chart.destroy();
          });
          if (allCharts.system.network) allCharts.system.network.destroy();
        });
      </script>

      <script>
      // --- Infer√™ncia Upload Helpers ---
      let preprocessedFiles = [];
      let lastInferenceResult = null;

      function updateInferStatus(msg) {
        const el = document.getElementById('inferStatus');
        if (el) el.textContent = msg;
      }

      async function preprocessSelectedImages() {
        const input = document.getElementById('inferImages');
        const sizeEl = document.getElementById('preproc_imgsz');
        const size = parseInt(sizeEl ? sizeEl.value : '640');
        if (!input || !input.files || input.files.length === 0) {
          updateInferStatus('Nenhuma imagem selecionada.');
          return;
        }
        updateInferStatus('Pr√©-processando imagens...');
        preprocessedFiles = [];
        for (const file of input.files) {
          const imgBitmap = await createImageBitmap(file);
          const canvas = document.createElement('canvas');
          canvas.width = size;
          canvas.height = size;
          const ctx = canvas.getContext('2d');
          ctx.fillStyle = '#000';
          ctx.fillRect(0, 0, size, size);
          const scale = Math.min(size / imgBitmap.width, size / imgBitmap.height);
          const newW = Math.round(imgBitmap.width * scale);
          const newH = Math.round(imgBitmap.height * scale);
          const dx = Math.round((size - newW) / 2);
          const dy = Math.round((size - newH) / 2);
          ctx.drawImage(imgBitmap, 0, 0, imgBitmap.width, imgBitmap.height, dx, dy, newW, newH);
          const blob = await new Promise(r => canvas.toBlob(r, 'image/jpeg', 0.92));
          const processedFile = new File([blob], file.name, { type: 'image/jpeg' });
          preprocessedFiles.push(processedFile);
        }
        updateInferStatus(`Pr√©-processadas ${preprocessedFiles.length} imagens.`);
      }

      function renameProcessedImages() {
        const regEl = document.getElementById('registro');
        const registro = regEl ? regEl.value : '';
        if (!registro) {
          updateInferStatus('Informe o Registro para renomear.');
          return;
        }
        if (!preprocessedFiles.length) {
          updateInferStatus('N√£o h√° imagens pr√©-processadas para renomear.');
          return;
        }
        const renamed = [];
        for (let i = 0; i < preprocessedFiles.length; i++) {
          const file = preprocessedFiles[i];
          const newName = `${registro}-${i + 1}.jpg`;
          const renamedFile = new File([file], newName, { type: file.type });
          renamed.push(renamedFile);
        }
        preprocessedFiles = renamed;
        updateInferStatus(`Renomeadas ${preprocessedFiles.length} imagens.`);
      }

      async function submitInference() {
        const registro = document.getElementById('registro')?.value || null;
        const ponto = document.getElementById('ponto')?.value || null;
        const sheet_id = document.getElementById('sheet_id')?.value || null;
        const send_webhook = document.getElementById('send_webhook_now')?.checked || false;

        let filesToSend = preprocessedFiles;
        if (!filesToSend.length) {
          const input = document.getElementById('inferImages');
          if (!input || !input.files || input.files.length === 0) {
            updateInferStatus('Nenhuma imagem dispon√≠vel para enviar.');
            return;
          }
          filesToSend = Array.from(input.files);
        }

        const form = new FormData();
        for (const f of filesToSend) form.append('files', f);
        if (registro && String(registro).trim() !== '') form.append('registro', String(registro).trim());
        if (ponto && String(ponto).trim() !== '') form.append('ponto', String(ponto).trim());
        if (sheet_id && String(sheet_id).trim() !== '') form.append('sheet_id', String(sheet_id).trim());
        form.append('send_webhook', String(send_webhook));

        updateInferStatus('Enviando para infer√™ncia...');
        try {
          const resp = await fetch('/infer', { method: 'POST', body: form });
          const text = await resp.text();
          if (!resp.ok) throw new Error(text || `HTTP ${resp.status}`);
          const data = JSON.parse(text);
          lastInferenceResult = data;
          updateInferStatus(`Infer√™ncia conclu√≠da. ${data.count} imagens processadas.`);
        } catch (e) {
          updateInferStatus('Falha na infer√™ncia: ' + (e && e.message ? e.message : e));
          console.error('Infer√™ncia erro:', e);
        }
      }

      async function sendToN8N() {
        if (!lastInferenceResult) {
          updateInferStatus('Nenhum resultado de infer√™ncia dispon√≠vel para enviar.');
          return;
        }
        updateInferStatus('Enviando resultados ao n8n...');
        try {
          const payload = {
            summary: lastInferenceResult.params || {},
            results: lastInferenceResult.results || [],
            meta: {
              registro: document.getElementById('registro')?.value || null,
              ponto: document.getElementById('ponto')?.value || null,
              sheet_id: document.getElementById('sheet_id')?.value || null
            }
          };
          const resp = await fetch('/webhook/send', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          if (!resp.ok) throw new Error(await resp.text());
          updateInferStatus('Webhook enviado com sucesso.');
        } catch (e) {
          updateInferStatus('Falha ao enviar webhook: ' + e.message);
        }
      }
      </script>

      <section class="section">
        <h2>Detec√ß√µes Recentes</h2>
        <div class="grid">
          {% for det in detections %}
          <div class="card">
            {% if det.annotated_url %}
            <img src="{{ det.annotated_url }}" alt="Detec√ß√£o" />
            {% endif %}
            <pre class="json">{{ det | tojson(indent=2) }}</pre>
          </div>
          {% endfor %}
        </div>
      </section>
    </main>
  </div>

  <section class="section system-monitor">
    <div class="network-traffic">
      <div class="card-header">
        <h3>Network Traffic</h3>
        <div class="card-actions">
          <button class="btn-icon" onclick="toggleFullscreen(this)">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
              <path d="M1.5 1.5h4v1h-3v3h-1v-4zm13 0v4h-1v-3h-3v-1h4zm-13 13v-4h1v3h3v1h-4zm13 0h-4v-1h3v-3h1v4z" fill="currentColor"/>
            </svg>
          </button>
        </div>
      </div>
      <canvas id="networkChart"></canvas>
    </div>
    
    <div class="system-stats">
      <div class="stat-card">
        <div class="card-header">
          <h3>CPU</h3>
          <div class="card-actions">
            <button class="btn-icon" onclick="toggleFullscreen(this)">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                <path d="M1.5 1.5h4v1h-3v3h-1v-4zm13 0v4h-1v-3h-3v-1h4zm-13 13v-4h1v3h3v1h-4zm13 0h-4v-1h3v-3h1v4z" fill="currentColor"/>
              </svg>
            </button>
          </div>
        </div>
        <div class="stat-value">
          <div class="progress-bar">
            <div class="progress" id="cpuProgress" style="width: 0%"></div>
            <span class="progress-text">0%</span>
          </div>
        </div>
        <div class="stat-details">
          <div class="detail-item">
            <span class="label">Processor:</span>
            <span class="value" id="cpuModel">-</span>
          </div>
          <div class="detail-item">
            <span class="label">Speed:</span>
            <span class="value" id="cpuSpeed">-</span>
          </div>
          <div class="detail-item">
            <span class="label">vCPU:</span>
            <span class="value" id="cpuCores">-</span>
          </div>
        </div>
      </div>
      
      <div class="stat-card">
        <div class="card-header">
          <h3>RAM</h3>
          <div class="card-actions">
            <button class="btn-icon" onclick="toggleFullscreen(this)">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                <path d="M1.5 1.5h4v1h-3v3h-1v-4zm13 0v4h-1v-3h-3v-1h4zm-13 13v-4h1v3h3v1h-4zm13 0h-4v-1h3v-3h1v4z" fill="currentColor"/>
              </svg>
            </button>
          </div>
        </div>
        <div class="stat-value">
          <div class="progress-bar">
            <div class="progress" id="ramProgress" style="width: 0%"></div>
            <span class="progress-text">0%</span>
          </div>
        </div>
        <div class="stat-details">
          <div class="detail-item">
            <span class="label">Memory Usage:</span>
            <span class="value" id="ramUsage">-</span>
          </div>
          <div class="detail-item">
            <span class="label">Clock Speed:</span>
            <span class="value" id="ramSpeed">-</span>
          </div>
          <div class="detail-item">
            <span class="label">Type:</span>
            <span class="value" id="ramType">-</span>
          </div>
        </div>
      </div>
      
      <div class="stat-card">
        <div class="card-header">
          <h3>HDD</h3>
          <div class="card-actions">
            <button class="btn-icon" onclick="toggleFullscreen(this)">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                <path d="M1.5 1.5h4v1h-3v3h-1v-4zm13 0v4h-1v-3h-3v-1h4zm-13 13v-4h1v3h3v1h-4zm13 0h-4v-1h3v-3h1v4z" fill="currentColor"/>
              </svg>
            </button>
          </div>
        </div>
        <div class="stat-value">
          <div class="progress-bar">
            <div class="progress" id="hddProgress" style="width: 0%"></div>
            <span class="progress-text">0%</span>
          </div>
        </div>
        <div class="stat-details">
          <div class="detail-item">
            <span class="label">Model:</span>
            <span class="value" id="hddModel">-</span>
          </div>
          <div class="detail-item">
            <span class="label">Type:</span>
            <span class="value" id="hddType">-</span>
          </div>
          <div class="detail-item">
            <span class="label">Capacity:</span>
            <span class="value" id="hddCapacity">-</span>
          </div>
        </div>
      </div>
    </div>
    
    <div class="system-info">
      <div class="info-card">
        <div class="info-item">
          <span class="label">IP:</span>
          <span class="value" id="systemIp">-</span>
        </div>
        <div class="info-item">
          <span class="label">OS:</span>
          <span class="value" id="systemOs">-</span>
        </div>
        <div class="info-item">
          <span class="label">Panel Version:</span>
          <span class="value" id="panelVersion">-</span>
        </div>
        <div class="info-item">
          <span class="label">Status:</span>
          <span class="value" id="systemStatus">-</span>
        </div>
      </div>
      <div class="info-card">
        <div class="info-item">
          <span class="label">Uptime:</span>
          <span class="value" id="systemUptime">-</span>
        </div>
      </div>
    </div>
  </section>

  <style>
    .system-monitor {
      margin-bottom: 2rem;
    }
    
    .network-traffic {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
      height: 200px;
    }
    
    .system-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1rem;
      margin-bottom: 1rem;
    }
    
    .stat-card {
      background: #121212;
      border: 1px solid #333333;
      border-radius: 8px;
      padding: 1rem;
    }
    
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    
    .card-header h3 {
      margin: 0;
      font-size: 1rem;
      font-weight: 500;
    }
    
    .card-actions {
      display: flex;
      gap: 0.5rem;
    }
    
    .btn-icon {
      background: none;
      border: none;
      color: #ffffff;
      padding: 4px;
      cursor: pointer;
      border-radius: 4px;
    }
    
    .btn-icon:hover {
      background: #21262d;
      color: #ffffff;
    }
    
    .stat-value {
      margin-bottom: 1rem;
    }
    
    .progress-bar {
      background: #0d1117;
      border-radius: 4px;
      height: 24px;
      position: relative;
      overflow: hidden;
    }
    
    .progress {
      background: #2563eb;
      height: 100%;
      width: 0%;
      transition: width 0.3s ease;
    }
    
    .progress-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #ffffff;
      font-size: 14px;
      z-index: 1;
    }
    
    .stat-details {
      display: grid;
      gap: 0.5rem;
    }
    
    .detail-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.875rem;
    }
    
    .detail-item .label {
      color: #ffffff;
    }
    
    .system-info {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1rem;
    }
    
    .info-card {
      background: #121212;
      border: 1px solid #333333;
      border-radius: 8px;
      padding: 1rem;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
    }
    
    .info-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.875rem;
    }
    
    .info-item .label {
      color: #ffffff;
    }
    
    .fullscreen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: 1000;
      padding: 2rem;
      background: #0d1117;
    }
  </style>

  <script>
    // Vari√°vel global para armazenar o job ativo
    let currentActiveJobId = null;
    let progressChart = null;

    function getAuthHeader() {
      const tok = localStorage.getItem('AUTH') || '';
      return tok ? (tok.startsWith('Bearer ') ? tok : ('Bearer ' + tok)) : '';
    }

    function setCurrentJobAndPause(jobId) { currentActiveJobId = jobId; pauseTraining(); }
    function setCurrentJobAndResume(jobId) { currentActiveJobId = jobId; resumeTraining(); }
    function setCurrentJobAndStop(jobId) { currentActiveJobId = jobId; stopTraining(); }

    async function clearJobs() {
      if (!confirm('Deseja realmente limpar o hist√≥rico de jobs? Esta a√ß√£o n√£o pode ser desfeita.')) return;
      try {
        const auth = getAuthHeader();
        const resp = await fetch('/train/jobs/clear', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            ...(auth ? { 'Authorization': auth } : {})
          }
        });
        if (resp.ok) {
          showNotification('Hist√≥rico de jobs limpo com sucesso', 'success');
          setTimeout(() => window.location.reload(), 800);
        } else {
          const err = await resp.json().catch(() => ({}));
          showNotification(err.detail || 'Falha ao limpar hist√≥rico de jobs', 'error');
        }
      } catch (e) {
        console.error('Erro ao limpar jobs', e);
        showNotification('Erro de conex√£o ao limpar jobs', 'error');
      }
    }

    async function pauseTraining() {
      if (!currentActiveJobId) {
        showNotification('Nenhum treinamento ativo encontrado', 'error');
        return;
      }

      try {
        const auth = getAuthHeader();
        const response = await fetch(`/train/${currentActiveJobId}/pause`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            ...(auth ? {'Authorization': auth} : {})
          }
        });

        if (response.ok) {
          const result = await response.json();
          showNotification('Treinamento pausado com sucesso', 'success');
          
          // Atualizar bot√µes
          document.getElementById('pauseBtn').style.display = 'none';
          document.getElementById('resumeBtn').style.display = 'flex';
          
          // Parar anima√ß√£o de pulso
          const pulseDot = document.querySelector('.pulse-dot');
          if (pulseDot) {
            pulseDot.style.background = '#f59e0b';
            pulseDot.style.animationPlayState = 'paused';
          }
          
          // Atualizar t√≠tulo
          const title = document.querySelector('.training-status h2');
          if (title) {
            title.textContent = '‚è∏Ô∏è Treinamento Pausado';
          }
        } else {
          const error = await response.json();
          showNotification(error.detail || 'Erro ao pausar treinamento', 'error');
        }
      } catch (error) {
        console.error('Erro ao pausar treinamento:', error);
        showNotification('Erro de conex√£o ao pausar treinamento', 'error');
      }
    }

    async function resumeTraining() {
      if (!currentActiveJobId) {
        showNotification('Nenhum treinamento encontrado', 'error');
        return;
      }

      try {
        const auth = getAuthHeader();
        const response = await fetch(`/train/${currentActiveJobId}/resume`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            ...(auth ? {'Authorization': auth} : {})
          }
        });

        if (response.ok) {
          const result = await response.json();
          showNotification('Treinamento retomado com sucesso', 'success');
          
          // Atualizar bot√µes
          document.getElementById('pauseBtn').style.display = 'flex';
          document.getElementById('resumeBtn').style.display = 'none';
          
          // Retomar anima√ß√£o de pulso
          const pulseDot = document.querySelector('.pulse-dot');
          if (pulseDot) {
            pulseDot.style.background = '#10b981';
            pulseDot.style.animationPlayState = 'running';
          }
          
          // Atualizar t√≠tulo
          const title = document.querySelector('.training-status h2');
          if (title) {
            title.textContent = 'üöÄ Treinamento em Andamento';
          }
        } else {
          const error = await response.json();
          showNotification(error.detail || 'Erro ao retomar treinamento', 'error');
        }
      } catch (error) {
        console.error('Erro ao retomar treinamento:', error);
        showNotification('Erro de conex√£o ao retomar treinamento', 'error');
      }
    }

    async function stopTraining() {
      if (!currentActiveJobId) {
        showNotification('Nenhum treinamento ativo encontrado', 'error');
        return;
      }

      // Confirmar a√ß√£o
      if (!confirm('Tem certeza que deseja parar o treinamento? Esta a√ß√£o n√£o pode ser desfeita.')) {
        return;
      }

      try {
        const auth = getAuthHeader();
        const response = await fetch(`/train/${currentActiveJobId}/stop`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            ...(auth ? {'Authorization': auth} : {})
          }
        });

        if (response.ok) {
          const result = await response.json();
          showNotification('Treinamento parado com sucesso', 'success');
          
          // Esconder se√ß√£o de treinamento ativo
          const activeTraining = document.getElementById('activeTraining');
          if (activeTraining) {
            activeTraining.style.display = 'none';
          }
          
          currentActiveJobId = null;
          
          // Recarregar p√°gina ap√≥s 2 segundos para atualizar lista de jobs
          setTimeout(() => {
            window.location.reload();
          }, 2000);
        } else {
          const error = await response.json();
          showNotification(error.detail || 'Erro ao parar treinamento', 'error');
        }
      } catch (error) {
        console.error('Erro ao parar treinamento:', error);
        showNotification('Erro de conex√£o ao parar treinamento', 'error');
      }
    }

    // Promover/Ativar modelo treinado
    async function promoteJob(jobId, bestPtPath, btnEl) {
      if (!jobId) {
        showNotification('Job inv√°lido para ativa√ß√£o', 'error');
        return;
      }

      const proceed = confirm('Ativar o modelo deste job para infer√™ncia?');
      if (!proceed) return;

      try {
        const auth = getAuthHeader();
        if (btnEl) {
          btnEl.disabled = true;
          const originalText = btnEl.textContent;
          btnEl.dataset.originalText = originalText;
          btnEl.textContent = 'Ativando...';
        }

        const payload = { job_id: jobId };
        if (bestPtPath && bestPtPath.trim() !== '' && bestPtPath !== '‚Äî') {
          payload.best_pt_path = bestPtPath;
        }

        const resp = await fetch('/models/promote', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            ...(auth ? { 'Authorization': auth } : {})
          },
          body: JSON.stringify(payload)
        });

        if (!resp.ok) {
          const err = await resp.json().catch(() => ({}));
          throw new Error(err.detail || 'Falha ao ativar modelo');
        }

        const data = await resp.json();
        const activePath = data.active_model || '(desconhecido)';
        showNotification('Modelo ativado com sucesso: ' + activePath, 'success');

        const activeModelEl = document.getElementById('activeModelPath');
        if (activeModelEl) activeModelEl.textContent = activePath;

        if (btnEl) {
          btnEl.textContent = 'Ativado ‚úì';
          btnEl.style.background = '#10b981';
          btnEl.style.borderColor = '#10b981';
        }
      } catch (e) {
        console.error('Erro ao ativar modelo', e);
        showNotification(e.message || 'Erro ao ativar modelo', 'error');
        if (btnEl) {
          btnEl.disabled = false;
          btnEl.textContent = btnEl.dataset.originalText || 'Ativar';
        }
      }
    }

    // Sistema de notifica√ß√µes
    function showNotification(message, type = 'info') {
      // Remover notifica√ß√£o existente
      const existingNotification = document.querySelector('.notification');
      if (existingNotification) {
        existingNotification.remove();
      }

      // Criar nova notifica√ß√£o
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.innerHTML = `
        <div class="notification-content">
          <span class="notification-icon">${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è'}</span>
          <span class="notification-message">${message}</span>
          <button class="notification-close" onclick="this.parentElement.parentElement.remove()">√ó</button>
        </div>
      `;

      // Adicionar estilos
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 10000;
        background: ${type === 'success' ? 'rgba(34, 197, 94, 0.9)' : type === 'error' ? 'rgba(239, 68, 68, 0.9)' : 'rgba(59, 130, 246, 0.9)'};
        color: white;
        padding: 16px 20px;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(10px);
        border: 1px solid ${type === 'success' ? 'rgba(34, 197, 94, 0.3)' : type === 'error' ? 'rgba(239, 68, 68, 0.3)' : 'rgba(59, 130, 246, 0.3)'};
        animation: slideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        max-width: 400px;
      `;

      document.body.appendChild(notification);

      // Auto-remover ap√≥s 5 segundos
      setTimeout(() => {
        if (notification.parentElement) {
          notification.style.animation = 'slideOut 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
          setTimeout(() => notification.remove(), 300);
        }
      }, 5000);
    }

    // Adicionar estilos de anima√ß√£o para notifica√ß√µes
    const notificationStyles = document.createElement('style');
    notificationStyles.textContent = `
      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
      
      @keyframes slideOut {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(100%);
          opacity: 0;
        }
      }
      
      .notification-content {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      
      .notification-close {
        background: none;
        border: none;
        color: white;
        font-size: 18px;
        cursor: pointer;
        padding: 0;
        margin-left: auto;
        opacity: 0.7;
        transition: opacity 0.2s;
      }
      
      .notification-close:hover {
        opacity: 1;
      }
    `;
    document.head.appendChild(notificationStyles);

    // Anima√ß√£o do bot√£o de treinamento
    document.addEventListener('DOMContentLoaded', function() {
      const trainForm = document.querySelector('form[action="/panel/upload"]');
      const trainBtn = document.getElementById('trainBtn');
      
      if (trainForm && trainBtn) {
        trainForm.addEventListener('submit', function(e) {
          // Adicionar classe de loading
          trainBtn.classList.add('loading');
          
          // Mostrar notifica√ß√£o
          showNotification('Iniciando treinamento...', 'info');
          
          // Simular delay para mostrar anima√ß√£o
          setTimeout(() => {
            // O formul√°rio ser√° submetido normalmente
          }, 500);
        });
      }
    });
  </script>
</body>
</html>