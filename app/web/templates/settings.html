<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{{ app_name }} ‚Äî Configura√ß√µes</title>
  <script>(function(){try{const saved=localStorage.getItem('ev_theme')||'system';const prefersDark=window.matchMedia('(prefers-color-scheme: dark)').matches;const isDark=(saved==='dark')||(saved==='system'&&prefersDark);document.documentElement.classList.toggle('dark',isDark);document.documentElement.setAttribute('data-theme',isDark?'dark':'light');}catch(e){}})();</script>
  <script>window.tailwind=window.tailwind||{};tailwind.config={darkMode:'class'};</script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: { extend: { fontFamily: { sans: ['Poppins','ui-sans-serif','system-ui','-apple-system','Segoe UI','Roboto','Ubuntu','Cantarell','sans-serif'] } } }
    }
  </script>
  <script>(function(){try{document.documentElement.classList.remove('dark');document.documentElement.setAttribute('data-theme','light');localStorage.setItem('ev_theme','light');}catch(e){}})();</script>
  <link rel="stylesheet" href="/static/style.css" />
  <style>
    .layout { display: grid; grid-template-columns: 240px 1fr; min-height: 100vh; }
    .sidebar { background: #ffffff; border-right: 1px solid #e5e7eb; padding: 16px; }
    .sidebar h2 { font-size: 18px; margin: 0 0 12px; }
    .sidebar a { display: block; color: #111827; text-decoration: none; padding: 8px 6px; border-radius: 6px; }
    .sidebar a:hover { background: #f3f4f6; }
    .sidebar a.active { background: #f9fafb; color: #111827; }
    .content { padding: 16px; }
    .section { margin-bottom: 24px; background: #ffffff; border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; }
    .section h2 { margin: 0 0 16px; font-size: 18px; border-bottom: 1px solid #e5e7eb; padding-bottom: 8px; }
    .form-group label { display: block; margin-bottom: 4px; color: #111827; font-size: 14px; }
    .input { background: #ffffff; color: #111827; border: 1px solid #e5e7eb; border-radius: 6px; padding: 8px; width: 100%; }
    .btn { background: #2563eb; color: #fff; border: none; border-radius: 6px; padding: 8px 12px; cursor: pointer; }
    .btn.secondary { background: #374151; }
    .muted { color: #6b7280; font-size: 12px; }
    .tabs { display: flex; border-bottom: 1px solid #e5e7eb; margin-bottom: 16px; }
    .table { width: 100%; border-collapse: collapse; margin-top: 16px; }
    .table th, .table td { border: 1px solid #e5e7eb; padding: 6px; }
    .copy-btn { background: #f3f4f6; border: 1px solid #e5e7eb; color: #111827; border-radius: 4px; padding: 2px 6px; cursor: pointer; font-size: 12px; }
    .copy-btn:hover { background: #e5e7eb; }
    .webhook-url code { background: #f9fafb; padding: 6px; border-radius: 4px; flex: 1; overflow-x: auto; }
  </style>
</head>
<body class="font-sans bg-white text-gray-900">
  <div class="layout grid min-h-screen" style="grid-template-columns: 240px 1fr;">
    <aside class="sidebar bg-white border-r border-gray-200 p-4">
      <div class="flex items-center justify-center mb-4">
        <a href="/panel" aria-label="Ir para painel">
          <img src="/static/ev_logo.svg" alt="{{ app_name }} logo" class="h-10 w-auto mx-auto" />
        </a>
      </div>
      <nav>
        <a href="/panel" class="block text-gray-700 px-2 py-2 rounded hover:bg-gray-50">Vis√£o Geral</a>
        <a href="/settings" class="active block text-gray-900 px-2 py-2 rounded bg-gray-50">Configura√ß√µes</a>
        <a href="/" class="block text-gray-700 px-2 py-2 rounded hover:bg-gray-50">In√≠cio simples</a>
        <a href="/docs" target="_blank" class="block text-gray-700 px-2 py-2 rounded hover:bg-gray-50">API Docs</a>
      </nav>
      <div class="section">
        <p class="muted">Modelo ativo:</p>
        <p>{{ active_model if active_model else 'Nenhum' }}</p>
      </div>
    </aside>
    <main class="content p-4">
      <header class="row flex items-center justify-between mb-4">
        <h1 class="text-xl font-semibold">Configura√ß√µes</h1>
        <div class="flex items-center gap-2">
          <button id="themeToggle" type="button" class="inline-flex items-center rounded-md border border-gray-300 bg-white px-3 py-1.5 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50" title="Tema fixo claro">
            <span class="sun">‚òÄÔ∏è</span>
            <span class="moon hidden">üåô</span>
          </button>
          <a class="btn secondary" href="/metrics" target="_blank">Ver M√©tricas</a>
          <form method="post" action="/logout">
            <button type="submit" class="inline-flex items-center rounded-md border border-gray-300 bg-white px-3 py-1.5 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-gray-300">Sair</button>
          </form>
        </div>
      </header>

      <div class="tabs flex border-b border-gray-200 mb-4">
        <div class="tab active px-4 py-2 cursor-pointer border-b-2 border-blue-500 text-gray-900" data-tab="webhooks">Webhooks</div>
        <div class="tab px-4 py-2 cursor-pointer border-b-2 border-transparent text-gray-600 hover:text-gray-900" data-tab="inference">Infer√™ncia</div>
        <div class="tab px-4 py-2 cursor-pointer border-b-2 border-transparent text-gray-600 hover:text-gray-900" data-tab="logs">Logs de Webhook</div>
        <div class="tab px-4 py-2 cursor-pointer border-b-2 border-transparent text-gray-600 hover:text-gray-900" data-tab="account">Conta</div>
      </div>

      <div class="tab-content" data-tab="account">
        <section class="section bg-white border border-gray-200 rounded-lg p-4">
          <h2>Conta (Admin)</h2>
          <form id="account-form" method="post" action="/settings/account" class="form-group">
            <input type="hidden" name="csrf_token" id="csrf_token_account" />
            <script>
              (function(){
                const m = document.cookie.match(/(?:^|; )ev_csrf=([^;]+)/);
                if (m) document.getElementById('csrf_token_account').value = decodeURIComponent(m[1]);
              })();
            </script>
            <div class="form-row">
              <div class="grid grid-cols-[200px_1fr] items-center gap-3">
                <label for="new_email" class="label m-0">Novo e-mail</label>
                <input class="input" type="email" id="new_email" name="new_email" placeholder="novo@empresa.com" />
                <p class="muted text-gray-500 col-start-2">Opcional ‚Äî altere seu e-mail de acesso</p>
              </div>
            </div>
            <div class="form-row grid md:grid-cols-2 gap-4">
              <div class="grid grid-cols-[200px_1fr] items-center gap-3">
                <label for="current_password" class="label m-0">Senha atual</label>
                <input class="input" type="password" id="current_password" name="current_password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
              </div>
              <div class="grid grid-cols-[200px_1fr] items-center gap-3">
                <label for="new_password" class="label m-0">Nova senha</label>
                <input class="input" type="password" id="new_password" name="new_password" placeholder="M√≠n. 8 caracteres" />
                <p class="muted col-start-2">Obrigat√≥rio informar a senha atual para alterar</p>
              </div>
            </div>
            <button class="btn bg-blue-600 text-white rounded-md px-3 py-2" type="submit">Salvar altera√ß√µes</button>
          </form>
        </section>
      </div>

      <div class="tab-content active" data-tab="webhooks">
        <section class="section bg-white border border-gray-200 rounded-lg p-4">
          <h2>Webhook de Entrada (Recebe Imagens)</h2>
          <form id="webhook-in-form" class="form-group">
            <div class="checkbox-row">
              <input type="checkbox" id="WEBHOOK_INFER_ENABLED" name="WEBHOOK_INFER_ENABLED" {{ 'checked' if cfg.WEBHOOK_INFER_ENABLED else '' }} />
              <label for="WEBHOOK_INFER_ENABLED" class="m-0">Habilitar webhook de entrada</label>
            </div>
            
            <div class="form-group">
              <label for="WEBHOOK_INFER_PATH" class="label m-0">Caminho do endpoint (ap√≥s /webhook/)</label>
              <input class="input" type="text" id="WEBHOOK_INFER_PATH" name="WEBHOOK_INFER_PATH" placeholder="infer" value="{{ cfg.WEBHOOK_INFER_PATH }}" pattern="^[a-zA-Z0-9_-]+$" />
              <p class="muted">Apenas letras, n√∫meros, tra√ßos e underscores</p>
            </div>
            
            <div class="form-group">
              <label for="WEBHOOK_INFER_TOKEN" class="label m-0">Token de seguran√ßa (opcional)</label>
              <input class="input" type="text" id="WEBHOOK_INFER_TOKEN" name="WEBHOOK_INFER_TOKEN" placeholder="Token para autentica√ß√£o" value="{{ cfg.WEBHOOK_INFER_TOKEN if cfg.WEBHOOK_INFER_TOKEN }}" />
              <p class="muted">Se definido, requisi√ß√µes precisam incluir header Authorization: Bearer &lt;token&gt;</p>
            </div>
            
            <div class="webhook-url">
              <span>URL:</span>
              <code id="webhook-url">{{ base_url }}webhook/{{ cfg.WEBHOOK_INFER_PATH }}</code>
              <button type="button" class="copy-btn" onclick="copyToClipboard('webhook-url')">Copiar</button>
            </div>
            
            <button class="btn" type="submit">Salvar</button>
          </form>
        </section>

        <section class="section bg-white border border-gray-200 rounded-lg p-4">
          <h2>Webhook de Sa√≠da (Envia para n8n)</h2>
          <form id="webhook-out-form" class="form-group">
            <div class="checkbox-row">
              <input type="checkbox" id="N8N_WEBHOOK_ENABLED" name="N8N_WEBHOOK_ENABLED" {{ 'checked' if cfg.N8N_WEBHOOK_ENABLED else '' }} />
              <label for="N8N_WEBHOOK_ENABLED" class="m-0">Habilitar envio para n8n</label>
            </div>
            
            <div class="form-group">
              <label for="N8N_WEBHOOK_URL" class="label m-0">URL do webhook n8n</label>
              <input class="input" type="url" id="N8N_WEBHOOK_URL" name="N8N_WEBHOOK_URL" placeholder="https://n8n.example.com/webhook/..." value="{{ cfg.N8N_WEBHOOK_URL if cfg.N8N_WEBHOOK_URL }}" />
            </div>
            
            <div class="checkbox-row">
              <input type="checkbox" id="N8N_WEBHOOK_INCLUDE_IMAGE" name="N8N_WEBHOOK_INCLUDE_IMAGE" {{ 'checked' if cfg.N8N_WEBHOOK_INCLUDE_IMAGE else '' }} />
              <label for="N8N_WEBHOOK_INCLUDE_IMAGE" class="m-0">Incluir imagem em base64 no payload</label>
            </div>
            
            <button class="btn" type="submit">Salvar</button>
          </form>
        </section>
      </div>

      <div class="tab-content" data-tab="inference">
        <section class="section bg-white border border-gray-200 rounded-lg p-4">
          <h2>Par√¢metros de Infer√™ncia</h2>
          <form id="inference-form" class="form-group">
            <div class="form-row">
              <div class="form-group">
                <label for="CONF_DEFAULT">Confian√ßa (0.01-0.99)</label>
                <input class="input" type="number" step="0.01" min="0.01" max="0.99" id="CONF_DEFAULT" name="CONF_DEFAULT" value="{{ cfg.CONF_DEFAULT }}" />
              </div>
              
              <div class="form-group">
                <label for="IOU_DEFAULT">IoU (0.01-0.99)</label>
                <input class="input" type="number" step="0.01" min="0.01" max="0.99" id="IOU_DEFAULT" name="IOU_DEFAULT" value="{{ cfg.IOU_DEFAULT }}" />
              </div>
              
              <div class="form-group">
                <label for="IMGSZ_DEFAULT">Tamanho da imagem (64-1536)</label>
                <input class="input" type="number" min="64" max="1536" id="IMGSZ_DEFAULT" name="IMGSZ_DEFAULT" value="{{ cfg.IMGSZ_DEFAULT }}" />
              </div>
              
              <div class="form-group">
                <label for="DEVICE_DEFAULT">Dispositivo (cuda:0, cpu)</label>
                <input class="input" type="text" id="DEVICE_DEFAULT" name="DEVICE_DEFAULT" placeholder="cuda:0 / cpu" value="{{ cfg.DEVICE_DEFAULT if cfg.DEVICE_DEFAULT }}" />
              </div>
            </div>
            
            <button class="btn" type="submit">Salvar</button>
          </form>
        </section>
      </div>

      <div class="tab-content" data-tab="logs">
        <section class="section bg-white border border-gray-200 rounded-lg p-4">
          <h2>Logs de Webhook</h2>
          <table class="table">
            <thead>
              <tr>
                <th>Timestamp</th>
                <th>Dire√ß√£o</th>
                <th>Endpoint</th>
                <th>Status</th>
                <th>Payload</th>
              </tr>
            </thead>
            <tbody>
              {% for log in webhook_logs %}
              <tr>
                <td>{{ log.timestamp }}</td>
                <td>
                  {% if log.direction == 'in' %}
                    <span class="pill in px-2 py-0.5 rounded-full text-xs font-medium">Entrada</span>
                  {% else %}
                    <span class="pill out px-2 py-0.5 rounded-full text-xs font-medium">Sa√≠da</span>
                  {% endif %}
                </td>
                <td class="endpoint">{{ log.endpoint }}</td>
                <td>
                  {% if log.status == 200 %}
                    <span class="pill in px-2 py-0.5 rounded-full text-xs font-medium">{{ log.status }}</span>
                  {% elif log.status == 0 %}
                    <span class="pill error px-2 py-0.5 rounded-full text-xs font-medium">Erro</span>
                  {% else %}
                    {{ log.status }}
                  {% endif %}
                </td>
                <td><pre class="json">{{ log.payload_summary | tojson(indent=2) }}</pre></td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          {% if not webhook_logs %}
          <p class="muted">Nenhum log de webhook registrado ainda.</p>
          {% endif %}
        </section>
      </div>
    </main>
  </div>

  <script>
    // Tabs
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        tab.classList.add('active');
        document.querySelector(`.tab-content[data-tab="${tab.dataset.tab}"]`).classList.add('active');
      });
    });
    
    // Copiar URL para clipboard
    function copyToClipboard(elementId) {
      const el = document.getElementById(elementId);
      const text = el.textContent;
      
      navigator.clipboard.writeText(text).then(() => {
        const btn = document.querySelector(`#${elementId} + .copy-btn`);
        const originalText = btn.textContent;
        btn.textContent = 'Copiado!';
        setTimeout(() => { btn.textContent = originalText; }, 2000);
      });
    }
    
    // Atualizar URL do webhook ao digitar
    document.getElementById('WEBHOOK_INFER_PATH').addEventListener('input', (e) => {
      const path = e.target.value || 'infer';
      document.getElementById('webhook-url').textContent = `{{ base_url }}webhook/${path}`;
    });
    
    // Formul√°rios
    async function submitForm(formId, successMsg) {
      const form = document.getElementById(formId);
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const formData = new FormData(form);
        const data = {};
        
        // Processar checkboxes e outros campos
        for (const [key, value] of formData.entries()) {
          if (form.elements[key].type === 'checkbox') {
            data[key] = form.elements[key].checked;
          } else if (value === '') {
            data[key] = null;
          } else {
            data[key] = value;
          }
        }
        
        // Adicionar checkboxes n√£o marcados (que n√£o aparecem no FormData)
        form.querySelectorAll('input[type="checkbox"]').forEach(cb => {
          if (!formData.has(cb.name)) {
            data[cb.name] = false;
          }
        });
        
        const tok = localStorage.getItem('AUTH') || '';
        const auth = tok ? (tok.startsWith('Bearer ') ? tok : ('Bearer ' + tok)) : '';
        
        try {
          const res = await fetch('/config', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': auth,
              'x-csrf-token': (document.cookie.match(/(?:^|; )ev_csrf=([^;]+)/)||[])[1] ? decodeURIComponent((document.cookie.match(/(?:^|; )ev_csrf=([^;]+)/)||[])[1]) : ''
            },
            body: JSON.stringify(data)
          });
          
          if (res.ok) {
            alert(successMsg || 'Configura√ß√µes salvas com sucesso!');
            location.reload();
          } else {
            const errorText = await res.text();
            alert(`Erro ao salvar: ${res.status} ${errorText}`);
          }
        } catch (err) {
          alert(`Erro: ${err.message}`);
        }
      });
    }
    
    // Inicializar formul√°rios
    submitForm('webhook-in-form', 'Configura√ß√µes do webhook de entrada salvas!');
    submitForm('webhook-out-form', 'Configura√ß√µes do webhook de sa√≠da salvas!');
    submitForm('inference-form', 'Par√¢metros de infer√™ncia salvos!');

    // Submit do formul√°rio de Conta
    document.getElementById('account-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.currentTarget;
      const formData = new FormData(form);
      try {
        const res = await fetch('/settings/account', {
          method: 'POST',
          body: formData
        });
        if (res.redirected) {
          window.location.href = res.url;
        } else if (res.ok) {
          alert('Conta atualizada com sucesso');
          location.reload();
        } else {
          const text = await res.text();
          alert('Erro ao atualizar conta: ' + text);
        }
      } catch (err) {
        alert('Erro: ' + err.message);
      }
    });
  </script>
  <script>
    (function(){
      function applyTheme(mode){
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        const isDark = (mode === 'dark') || (mode === 'system' && prefersDark);
        document.documentElement.classList.toggle('dark', isDark);
        document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
        const sun = document.querySelector('#themeToggle .sun');
        const moon = document.querySelector('#themeToggle .moon');
        if (sun && moon) {
          sun.classList.toggle('hidden', isDark);
          moon.classList.toggle('hidden', !isDark);
        }
      }
      const saved = localStorage.getItem('ev_theme') || 'system';
      applyTheme(saved);
      const btn = document.getElementById('themeToggle');
      if (btn) {
        btn.addEventListener('click', () => {
          const cur = localStorage.getItem('ev_theme') || 'system';
          const next = cur === 'light' ? 'dark' : (cur === 'dark' ? 'system' : 'light');
          localStorage.setItem('ev_theme', next);
          applyTheme(next);
        });
      }
      try {
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
          const mode = localStorage.getItem('ev_theme') || 'system';
          applyTheme(mode);
        });
      } catch (e) {}
    })();
  </script>
</body>
</html>